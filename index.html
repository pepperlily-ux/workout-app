<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>메타몽 과부하</title>
    <meta name="description" content="메타몽과 함께하는 점진적 과부하 기록 앱">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <meta name="theme-color" content="#FFFFFF">
    <!-- 폰트 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quantico:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <style>
        html {
            overscroll-behavior-y: contain;
        }

        body {
            overscroll-behavior-y: contain;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* 스크롤바 숨기기 (기능은 유지) */
        .hide-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;  /* Chrome, Safari, Opera */
        }
        /* 스플래시 화면 */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        #splash-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .splash-text {
            text-align: center;
            margin-bottom: 40px;
        }
        .splash-title {
            color: black;
            font-size: 28px;
            font-family: 'Pretendard', sans-serif;
            font-weight: 600;
            line-height: 38px;
        }
        .splash-subtitle {
            color: #847DC4;
            font-size: 28px;
            font-family: 'Pretendard', sans-serif;
            font-weight: 600;
            line-height: 38px;
        }
        .splash-logo {
            width: 203px;
            height: 203px;
            margin-bottom: 80px;
        }
        .splash-footer {
            position: absolute;
            bottom: 60px;
            color: #AFAFAF;
            font-size: 28px;
            font-family: 'Quantico', sans-serif;
            font-weight: 700;
        }

        .splash-version {
            position: absolute;
            bottom: 40px;
            color: #C5C5C5;
            font-size: 14px;
            font-family: 'Pretendard', sans-serif;
            font-weight: 400;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-white">
    <!-- 스플래시 화면 -->
    <div id="splash-screen">
        <div class="splash-text">
            <div class="splash-title">메타몽과 함께하는</div>
            <div class="splash-subtitle">점진적 과부하</div>
        </div>
        <img class="splash-logo" src="icon-512.png" alt="메타몽" />
        <div class="splash-footer">Lily.</div>
        <div class="splash-version">sw ver.75</div>
    </div>
    
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // 로컬스토리지 키
        const STORAGE_KEYS = {
            WORKOUTS: 'workout_exercises',
            RECORDS: 'workout_records',
            ROUTINES: 'workout_routines',
            CHECKED_SETS: 'metamong-checked-sets'
        };

        // 입력 필드 제한 상수
        const LIMITS = {
            weightMax: 999,        // 무게 최대값 (kg)
            repsMax: 99,           // 횟수 최대값 (회)
            weightLen: 5,          // 무게 입력 최대 글자수 (999.9)
            repsLen: 2,            // 횟수 입력 최대 글자수 (99)
            weightDecimals: 1      // 무게 소수점 자릿수
        };

        // 데이터 로드 및 저장 함수
        const loadData = (key) => {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch {
                return null;
            }
        };

        const saveData = (key, data) => {
            localStorage.setItem(key, JSON.stringify(data));
        };

        // 날짜 포맷 함수
        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const formatDateKorean = (dateStr) => {
            const [year, month, day] = dateStr.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            const days = ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'];
            const dayOfWeek = days[date.getDay()];
            return `${date.getMonth() + 1}월 ${date.getDate()}일 ${dayOfWeek}`;
        };

        // 난이도 정보 반환
        const getDifficultyInfo = (difficulty) => {
            const difficulties = {
                easy: {
                    text: '쉬웠다',
                    icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2.25C10.0716 2.25 8.18657 2.82183 6.58319 3.89317C4.97982 4.96452 3.73013 6.48726 2.99218 8.26884C2.25422 10.0504 2.06114 12.0108 2.43735 13.9021C2.81355 15.7934 3.74215 17.5307 5.10571 18.8943C6.46928 20.2579 8.20656 21.1865 10.0979 21.5627C11.9892 21.9389 13.9496 21.7458 15.7312 21.0078C17.5127 20.2699 19.0355 19.0202 20.1068 17.4168C21.1782 15.8134 21.75 13.9284 21.75 12C21.7473 9.41498 20.7192 6.93661 18.8913 5.10872C17.0634 3.28084 14.585 2.25273 12 2.25ZM12 20.25C10.3683 20.25 8.77326 19.7661 7.41655 18.8596C6.05984 17.9531 5.00242 16.6646 4.378 15.1571C3.75358 13.6496 3.5902 11.9908 3.90853 10.3905C4.22685 8.79016 5.01259 7.32015 6.16637 6.16637C7.32016 5.01259 8.79017 4.22685 10.3905 3.90852C11.9909 3.59019 13.6497 3.75357 15.1571 4.37799C16.6646 5.00242 17.9531 6.05984 18.8596 7.41655C19.7662 8.77325 20.25 10.3683 20.25 12C20.2475 14.1873 19.3775 16.2843 17.8309 17.8309C16.2843 19.3775 14.1873 20.2475 12 20.25ZM7.5 10.125C7.5 9.9025 7.56598 9.68499 7.6896 9.49998C7.81322 9.31498 7.98892 9.17078 8.19449 9.08564C8.40005 9.00049 8.62625 8.97821 8.84448 9.02162C9.06271 9.06502 9.26317 9.17217 9.4205 9.3295C9.57783 9.48684 9.68498 9.68729 9.72839 9.90552C9.7718 10.1238 9.74952 10.35 9.66437 10.5555C9.57922 10.7611 9.43503 10.9368 9.25002 11.0604C9.06502 11.184 8.84751 11.25 8.625 11.25C8.32664 11.25 8.04049 11.1315 7.82951 10.9205C7.61853 10.7095 7.5 10.4234 7.5 10.125ZM16.5 10.125C16.5 10.3475 16.434 10.565 16.3104 10.75C16.1868 10.935 16.0111 11.0792 15.8055 11.1644C15.6 11.2495 15.3738 11.2718 15.1555 11.2284C14.9373 11.185 14.7368 11.0778 14.5795 10.9205C14.4222 10.7632 14.315 10.5627 14.2716 10.3445C14.2282 10.1262 14.2505 9.90005 14.3356 9.69448C14.4208 9.48891 14.565 9.31321 14.75 9.1896C14.935 9.06598 15.1525 9 15.375 9C15.6734 9 15.9595 9.11853 16.1705 9.3295C16.3815 9.54048 16.5 9.82663 16.5 10.125ZM16.3997 14.625C15.435 16.2928 13.8309 17.25 12 17.25C10.1691 17.25 8.56594 16.2937 7.60125 14.625C7.54699 14.5396 7.51055 14.4442 7.49413 14.3444C7.47772 14.2446 7.48166 14.1425 7.50573 14.0442C7.52979 13.946 7.57348 13.8536 7.63417 13.7727C7.69485 13.6917 7.77128 13.6239 7.85886 13.5733C7.94643 13.5227 8.04334 13.4903 8.14375 13.4781C8.24417 13.4659 8.34601 13.4742 8.44316 13.5023C8.5403 13.5305 8.63074 13.5781 8.70904 13.6421C8.78734 13.7062 8.85187 13.7854 8.89875 13.875C9.59907 15.0853 10.6997 15.75 12 15.75C13.3003 15.75 14.4009 15.0844 15.1003 13.875C15.1998 13.7027 15.3636 13.5769 15.5558 13.5254C15.7479 13.4739 15.9527 13.5009 16.125 13.6003C16.2973 13.6998 16.4231 13.8636 16.4746 14.0558C16.5261 14.2479 16.4991 14.4527 16.3997 14.625Z" fill="currentColor"/></svg>'
                },
                medium: {
                    text: '할만했다',
                    icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2.25C10.0716 2.25 8.18657 2.82183 6.58319 3.89317C4.97982 4.96452 3.73013 6.48726 2.99218 8.26884C2.25422 10.0504 2.06114 12.0108 2.43735 13.9021C2.81355 15.7934 3.74215 17.5307 5.10571 18.8943C6.46928 20.2579 8.20656 21.1865 10.0979 21.5627C11.9892 21.9389 13.9496 21.7458 15.7312 21.0078C17.5127 20.2699 19.0355 19.0202 20.1068 17.4168C21.1782 15.8134 21.75 13.9284 21.75 12C21.7473 9.41498 20.7192 6.93661 18.8913 5.10872C17.0634 3.28084 14.585 2.25273 12 2.25ZM12 20.25C10.3683 20.25 8.77326 19.7661 7.41655 18.8596C6.05984 17.9531 5.00242 16.6646 4.378 15.1571C3.75358 13.6496 3.5902 11.9908 3.90853 10.3905C4.22685 8.79016 5.01259 7.32015 6.16637 6.16637C7.32016 5.01259 8.79017 4.22685 10.3905 3.90852C11.9909 3.59019 13.6497 3.75357 15.1571 4.37799C16.6646 5.00242 17.9531 6.05984 18.8596 7.41655C19.7662 8.77325 20.25 10.3683 20.25 12C20.2475 14.1873 19.3775 16.2843 17.8309 17.8309C16.2843 19.3775 14.1873 20.2475 12 20.25ZM16.5 15C16.5 15.1989 16.421 15.3897 16.2803 15.5303C16.1397 15.671 15.9489 15.75 15.75 15.75H8.25C8.05109 15.75 7.86033 15.671 7.71967 15.5303C7.57902 15.3897 7.5 15.1989 7.5 15C7.5 14.8011 7.57902 14.6103 7.71967 14.4697C7.86033 14.329 8.05109 14.25 8.25 14.25H15.75C15.9489 14.25 16.1397 14.329 16.2803 14.4697C16.421 14.6103 16.5 14.8011 16.5 15ZM7.5 10.125C7.5 9.9025 7.56598 9.68499 7.6896 9.49998C7.81322 9.31498 7.98892 9.17078 8.19449 9.08564C8.40005 9.00049 8.62625 8.97821 8.84448 9.02162C9.06271 9.06502 9.26317 9.17217 9.4205 9.3295C9.57783 9.48684 9.68498 9.68729 9.72839 9.90552C9.7718 10.1238 9.74952 10.35 9.66437 10.5555C9.57922 10.7611 9.43503 10.9368 9.25002 11.0604C9.06502 11.184 8.84751 11.25 8.625 11.25C8.32664 11.25 8.04049 11.1315 7.82951 10.9205C7.61853 10.7095 7.5 10.4234 7.5 10.125ZM16.5 10.125C16.5 10.3475 16.434 10.565 16.3104 10.75C16.1868 10.935 16.0111 11.0792 15.8055 11.1644C15.6 11.2495 15.3738 11.2718 15.1555 11.2284C14.9373 11.185 14.7368 11.0778 14.5795 10.9205C14.4222 10.7632 14.315 10.5627 14.2716 10.3445C14.2282 10.1262 14.2505 9.90005 14.3356 9.69448C14.4208 9.48891 14.565 9.31321 14.75 9.1896C14.935 9.06598 15.1525 9 15.375 9C15.6734 9 15.9595 9.11853 16.1705 9.3295C16.3815 9.54048 16.5 9.82663 16.5 10.125Z" fill="currentColor"/></svg>'
                },
                hard: {
                    text: '겨우했다',
                    icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16.4997 13.1246C16.4997 13.3471 16.4337 13.5646 16.3101 13.7496C16.1865 13.9346 16.0108 14.0788 15.8052 14.1639C15.5996 14.2491 15.3734 14.2714 15.1552 14.2279C14.937 14.1845 14.7365 14.0774 14.5792 13.9201C14.4218 13.7627 14.3147 13.5623 14.2713 13.344C14.2279 13.1258 14.2502 12.8996 14.3353 12.694C14.4205 12.4885 14.5647 12.3128 14.7497 12.1892C14.9347 12.0655 15.1522 11.9996 15.3747 11.9996C15.673 11.9996 15.9592 12.1181 16.1702 12.3291C16.3811 12.54 16.4997 12.8262 16.4997 13.1246ZM11.9997 8.62456C11.9997 8.40205 11.9337 8.18455 11.8101 7.99954C11.6865 7.81454 11.5108 7.67034 11.3052 7.58519C11.0996 7.50005 10.8734 7.47777 10.6552 7.52118C10.437 7.56458 10.2365 7.67173 10.0792 7.82906C9.92184 7.9864 9.8147 8.18685 9.77129 8.40508C9.72788 8.62331 9.75016 8.84951 9.83531 9.05508C9.92046 9.26064 10.0647 9.43635 10.2497 9.55996C10.4347 9.68358 10.6522 9.74956 10.8747 9.74956C11.173 9.74956 11.4592 9.63103 11.6702 9.42005C11.8811 9.20908 11.9997 8.92293 11.9997 8.62456ZM18.8434 5.06206C17.036 3.30485 14.6183 2.31595 12.0975 2.30287C9.57672 2.28978 7.14885 3.25352 5.3233 4.99187C3.49775 6.73021 2.41642 9.10805 2.30621 11.6265C2.19599 14.1449 3.06546 16.6081 4.73217 18.4992C4.79735 18.5744 4.87682 18.6359 4.96598 18.68C5.05514 18.7242 5.15219 18.7502 5.25149 18.7565C5.35078 18.7628 5.45034 18.7492 5.54435 18.7167C5.63837 18.6841 5.72496 18.6332 5.7991 18.5668C5.87323 18.5004 5.93342 18.42 5.97616 18.3301C6.01889 18.2403 6.04333 18.1428 6.04804 18.0435C6.05274 17.9441 6.03763 17.8447 6.00357 17.7513C5.96952 17.6578 5.9172 17.572 5.84967 17.4989C4.78804 16.3118 4.09269 14.8429 3.84754 13.2693C3.60239 11.6957 3.81792 10.0848 4.46812 8.63103C5.11833 7.17726 6.17541 5.94274 7.51177 5.0765C8.84813 4.21026 10.4066 3.74932 11.9992 3.74932C13.5918 3.74932 15.1503 4.21026 16.4866 5.0765C17.823 5.94274 18.8801 7.17726 19.5303 8.63103C20.1805 10.0848 20.396 11.6957 20.1509 13.2693C19.9057 14.8429 19.2104 16.3118 18.1487 17.4989C18.0161 17.6472 17.9478 17.8422 17.9589 18.0409C17.9699 18.2395 18.0595 18.4257 18.2078 18.5583C18.3561 18.691 18.551 18.7593 18.7497 18.7482C18.9484 18.7371 19.1345 18.6476 19.2672 18.4992C20.9345 16.6331 21.8204 14.1972 21.7415 11.6959C21.6626 9.19466 20.625 6.81948 18.8434 5.06206ZM14.2497 15.7496H12.7497C10.7115 15.7496 8.24967 14.0771 8.24967 11.9996C8.24988 11.7898 8.26712 11.5803 8.30124 11.3733C8.31849 11.2757 8.31624 11.1757 8.29462 11.079C8.273 10.9824 8.23244 10.8909 8.17528 10.81C8.11811 10.7291 8.04548 10.6603 7.96158 10.6076C7.87768 10.5549 7.78417 10.5193 7.68645 10.503C7.58873 10.4866 7.48874 10.4898 7.39226 10.5123C7.29577 10.5348 7.20471 10.5762 7.12432 10.6342C7.04393 10.6921 6.97581 10.7653 6.9239 10.8497C6.87198 10.9341 6.8373 11.0279 6.82186 11.1258C6.77386 11.4146 6.74972 11.7068 6.74967 11.9996C6.74967 13.3946 7.44905 14.7305 8.71842 15.7636C9.88092 16.7077 11.35 17.2496 12.7497 17.2496H14.2497C14.4486 17.2496 14.6394 17.3286 14.78 17.4692C14.9207 17.6099 14.9997 17.8006 14.9997 17.9996C14.9997 18.1985 14.9207 18.3892 14.78 18.5299C14.6394 18.6705 14.4486 18.7496 14.2497 18.7496H8.99967C8.40294 18.7496 7.83064 18.9866 7.40868 19.4086C6.98673 19.8305 6.74967 20.4028 6.74967 20.9996C6.74967 21.5963 6.98673 22.1686 7.40868 22.5905C7.83064 23.0125 8.40294 23.2496 8.99967 23.2496C9.19858 23.2496 9.38935 23.1705 9.53 23.0299C9.67065 22.8892 9.74967 22.6985 9.74967 22.4996C9.74967 22.3006 9.67065 22.1099 9.53 21.9692C9.38935 21.8286 9.19858 21.7496 8.99967 21.7496C8.80076 21.7496 8.60999 21.6705 8.46934 21.5299C8.32869 21.3892 8.24967 21.1985 8.24967 20.9996C8.24967 20.8006 8.32869 20.6099 8.46934 20.4692C8.60999 20.3286 8.80076 20.2496 8.99967 20.2496H14.2497C14.8464 20.2496 15.4187 20.0125 15.8407 19.5905C16.2626 19.1686 16.4997 18.5963 16.4997 17.9996C16.4997 17.4028 16.2626 16.8305 15.8407 16.4086C15.4187 15.9866 14.8464 15.7496 14.2497 15.7496Z" fill="currentColor"/></svg>'
                }
            };
            return difficulties[difficulty] || null;
        };

        // 메인 앱 컴포넌트
        function App() {
            const [currentPage, setCurrentPage] = useState('home');
            const [exercises, setExercises] = useState(loadData(STORAGE_KEYS.WORKOUTS) || []);
            const [records, setRecords] = useState(loadData(STORAGE_KEYS.RECORDS) || []);
            const [routines, setRoutines] = useState(loadData(STORAGE_KEYS.ROUTINES) || []);
            const [selectedDate, setSelectedDate] = useState(formatDate(new Date()));

            useEffect(() => {
                saveData(STORAGE_KEYS.WORKOUTS, exercises);
            }, [exercises]);

            useEffect(() => {
                saveData(STORAGE_KEYS.RECORDS, records);
            }, [records]);

            useEffect(() => {
                saveData(STORAGE_KEYS.ROUTINES, routines);
            }, [routines]);

            const addExercise = (exercise) => {
                setExercises([...exercises, { ...exercise, id: Date.now() }]);
            };

            const addRoutine = (routine) => {
                setRoutines([...routines, { ...routine, id: Date.now() }]);
            };

            const addRecord = (record) => {
                setRecords([...records, { ...record, id: Date.now() }]);
            };

            const addRecords = (newRecords) => {
                const recordsWithIds = newRecords.map((record, index) => ({
                    ...record,
                    id: Date.now() + index
                }));
                setRecords([...records, ...recordsWithIds]);
            };

            const updateRecord = (id, updates) => {
                setRecords(records.map(r => r.id === id ? { ...r, ...updates } : r));
            };

            const deleteRecord = (id) => {
                setRecords(records.filter(r => r.id !== id));
            };

            return (
                <div className="max-w-md mx-auto min-h-screen bg-white">
                    {/* 네비게이션 */}
                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 max-w-md mx-auto z-20">
                        <div className="flex justify-around">
                            <button
                                onClick={() => setCurrentPage('home')}
                                className="flex-1 py-3 flex flex-col items-center"
                            >
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M2 12.2039C2 9.91549 2 8.77128 2.5192 7.82274C3.0384 6.87421 3.98695 6.28551 5.88403 5.10813L7.88403 3.86687C9.88939 2.62229 10.8921 2 12 2C13.1079 2 14.1106 2.62229 16.116 3.86687L18.116 5.10812C20.0131 6.28551 20.9616 6.87421 21.4808 7.82274C22 8.77128 22 9.91549 22 12.2039V13.725C22 17.6258 22 19.5763 20.8284 20.7881C19.6569 22 17.7712 22 14 22H10C6.22876 22 4.34315 22 3.17157 20.7881C2 19.5763 2 17.6258 2 13.725V12.2039Z" stroke={currentPage === 'home' ? '#A295D5' : '#6E6475'} strokeWidth="1.5"/>
                                    <path d="M9 16C9.85038 16.6303 10.8846 17 12 17C13.1154 17 14.1496 16.6303 15 16" stroke={currentPage === 'home' ? '#A295D5' : '#6E6475'} strokeWidth="1.5" strokeLinecap="round"/>
                                </svg>
                                <div className={`text-xs mt-1 ${currentPage === 'home' ? 'text-[#A295D5]' : 'text-[#6E6475]'}`}>홈</div>
                            </button>
                            <button
                                onClick={() => setCurrentPage('calendar')}
                                className="flex-1 py-3 flex flex-col items-center"
                            >
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M2 12C2 8.22876 2 6.34315 3.17157 5.17157C4.34315 4 6.22876 4 10 4H14C17.7712 4 19.6569 4 20.8284 5.17157C22 6.34315 22 8.22876 22 12V14C22 17.7712 22 19.6569 20.8284 20.8284C19.6569 22 17.7712 22 14 22H10C6.22876 22 4.34315 22 3.17157 20.8284C2 19.6569 2 17.7712 2 14V12Z" stroke={currentPage === 'calendar' ? '#A295D5' : '#6E6475'} strokeWidth="1.5"/>
                                    <path d="M7 4V2.5" stroke={currentPage === 'calendar' ? '#A295D5' : '#6E6475'} strokeWidth="1.5" strokeLinecap="round"/>
                                    <path d="M17 4V2.5" stroke={currentPage === 'calendar' ? '#A295D5' : '#6E6475'} strokeWidth="1.5" strokeLinecap="round"/>
                                    <path d="M2.5 9H21.5" stroke={currentPage === 'calendar' ? '#A295D5' : '#6E6475'} strokeWidth="1.5" strokeLinecap="round"/>
                                    <path d="M18 17C18 17.5523 17.5523 18 17 18C16.4477 18 16 17.5523 16 17C16 16.4477 16.4477 16 17 16C17.5523 16 18 16.4477 18 17Z" fill={currentPage === 'calendar' ? '#A295D5' : '#6E6475'}/>
                                    <path d="M18 13C18 13.5523 17.5523 14 17 14C16.4477 14 16 13.5523 16 13C16 12.4477 16.4477 12 17 12C17.5523 12 18 12.4477 18 13Z" fill={currentPage === 'calendar' ? '#A295D5' : '#6E6475'}/>
                                    <path d="M13 17C13 17.5523 12.5523 18 12 18C11.4477 18 11 17.5523 11 17C11 16.4477 11.4477 16 12 16C12.5523 16 13 16.4477 13 17Z" fill={currentPage === 'calendar' ? '#A295D5' : '#6E6475'}/>
                                    <path d="M13 13C13 13.5523 12.5523 14 12 14C11.4477 14 11 13.5523 11 13C11 12.4477 11.4477 12 12 12C12.5523 12 13 12.4477 13 13Z" fill={currentPage === 'calendar' ? '#A295D5' : '#6E6475'}/>
                                    <path d="M8 17C8 17.5523 7.55228 18 7 18C6.44772 18 6 17.5523 6 17C6 16.4477 6.44772 16 7 16C7.55228 16 8 16.4477 8 17Z" fill={currentPage === 'calendar' ? '#A295D5' : '#6E6475'}/>
                                    <path d="M8 13C8 13.5523 7.55228 14 7 14C6.44772 14 6 13.5523 6 13C6 12.4477 6.44772 12 7 12C7.55228 12 8 12.4477 8 13Z" fill={currentPage === 'calendar' ? '#A295D5' : '#6E6475'}/>
                                </svg>
                                <div className={`text-xs mt-1 ${currentPage === 'calendar' ? 'text-[#A295D5]' : 'text-[#6E6475]'}`}>캘린더</div>
                            </button>
                            <button
                                onClick={() => setCurrentPage('routines')}
                                className="flex-1 py-3 flex flex-col items-center"
                            >
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M20 15.6818V11.1878C20 7.32802 20 5.39814 18.8284 4.19907C17.6569 3 15.7712 3 12 3C8.22876 3 6.34315 3 5.17157 4.19907C4 5.39814 4 7.32802 4 11.1878V15.6818C4 18.4687 4 19.8622 4.65254 20.4711C4.96375 20.7615 5.35658 20.9439 5.77504 20.9924C6.65246 21.094 7.6771 20.1764 9.72636 18.3412C10.6322 17.53 11.0851 17.1244 11.6091 17.0176C11.8672 16.9649 12.1328 16.9649 12.3909 17.0176C12.9149 17.1244 13.3678 17.53 14.2736 18.3412C16.3229 20.1764 17.3475 21.094 18.225 20.9924C18.6434 20.9439 19.0363 20.7615 19.3475 20.4711C20 19.8622 20 18.4687 20 15.6818Z" stroke={currentPage === 'routines' ? '#A295D5' : '#6E6475'} strokeWidth="1.5"/>
                                    <path d="M15 7H9" stroke={currentPage === 'routines' ? '#A295D5' : '#6E6475'} strokeWidth="2" strokeLinecap="round"/>
                                </svg>
                                <div className={`text-xs mt-1 ${currentPage === 'routines' ? 'text-[#A295D5]' : 'text-[#6E6475]'}`}>루틴</div>
                            </button>
                            <button
                                onClick={() => setCurrentPage('exercises')}
                                className="flex-1 py-3 flex flex-col items-center"
                            >
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M3.92443 18.6073L4.45475 18.077L3.92443 18.6073ZM5.39271 20.0756L4.86238 20.6059L5.39271 20.0756ZM9.06343 20.0756L8.5331 20.6059H8.5331L9.06343 20.0756ZM9.79757 20.8097L10.3279 20.2794L10.3279 20.2794L9.79757 20.8097ZM14.6055 19.3774L13.8811 19.1833L13.8811 19.1833L14.6055 19.3774ZM14.6055 18.5713L13.8811 18.7654L14.6055 18.5713ZM12.036 21.9469L11.8419 21.2225H11.8419L12.036 21.9469ZM11.2299 21.9469L11.424 21.2225L11.2299 21.9469ZM2.05306 11.964L2.77751 12.1581V12.1581L2.05306 11.964ZM3.19028 14.2024L2.65995 14.7328L3.19028 14.2024ZM2.05306 12.7701L1.32862 12.9643L2.05306 12.7701ZM4.62257 9.3945L4.81668 10.1189H4.81668L4.62257 9.3945ZM5.42871 9.3945L5.62283 8.67005V8.67005L5.42871 9.3945ZM20.0756 9.06343L19.5452 9.59376L20.0756 9.06343ZM20.8097 9.79757L21.34 9.26724L20.8097 9.79757ZM19.3774 14.6055L19.1833 13.8811H19.1833L19.3774 14.6055ZM18.5713 14.6055L18.7654 13.8811L18.7654 13.8811L18.5713 14.6055ZM21.9469 12.036L21.2225 11.8419L21.2225 11.8419L21.9469 12.036ZM21.9469 11.2299L21.2225 11.424L21.2225 11.424L21.9469 11.2299ZM11.964 2.05307L11.7699 1.32862V1.32862L11.964 2.05307ZM14.2024 3.19028L13.6721 3.72061L14.2024 3.19028ZM12.7701 2.05307L12.576 2.77751V2.77751L12.7701 2.05307ZM9.3945 4.62257L8.67005 4.42845V4.42845L9.3945 4.62257ZM9.3945 5.42871L10.1189 5.2346V5.2346L9.3945 5.42871ZM7.02426 16.9757C7.31715 17.2686 7.31715 17.7435 7.02426 18.0364C6.73136 18.3293 6.25649 18.3293 5.9636 18.0364L6.49393 17.5061L7.02426 16.9757ZM18.0364 5.9636C18.3293 6.25649 18.3293 6.73136 18.0364 7.02426C17.7435 7.31715 17.2686 7.31715 16.9757 7.02426L17.5061 6.49393L18.0364 5.9636ZM11.6329 7.96221L12.1633 7.43188L11.6329 7.96221ZM3.92443 18.6073L4.45475 18.077L5.92304 19.5452L5.39271 20.0756L4.86238 20.6059L3.39409 19.1376L3.92443 18.6073ZM20.0756 5.39271L19.5452 5.92304L18.077 4.45475L18.6073 3.92442L19.1376 3.39409L20.6059 4.86238L20.0756 5.39271ZM20.0756 8.32928L19.5452 7.79895C19.9063 7.43788 20.1226 7.2193 20.258 7.04192C20.3203 6.96028 20.346 6.9114 20.3567 6.88584C20.3649 6.86626 20.3638 6.86179 20.3638 6.861H21.1138L21.8638 6.861C21.8638 7.30594 21.6745 7.65828 21.4505 7.95179C21.2398 8.22799 20.937 8.52853 20.6059 8.85961L20.0756 8.32928ZM20.0756 5.39271L20.6059 4.86238C20.937 5.19347 21.2398 5.49401 21.4505 5.77021C21.6745 6.06372 21.8638 6.41605 21.8638 6.861L21.1138 6.861H20.3638C20.3638 6.8602 20.3649 6.85573 20.3567 6.83615C20.346 6.8106 20.3203 6.76171 20.258 6.68008C20.1226 6.50269 19.9063 6.28411 19.5452 5.92304L20.0756 5.39271ZM5.39271 20.0756L5.92304 19.5452C6.28411 19.9063 6.50269 20.1226 6.68008 20.258C6.76171 20.3203 6.8106 20.346 6.83615 20.3567C6.85573 20.3649 6.8602 20.3638 6.861 20.3638L6.861 21.1138L6.861 21.8638C6.41605 21.8638 6.06372 21.6745 5.77021 21.4505C5.49401 21.2398 5.19347 20.937 4.86238 20.6059L5.39271 20.0756ZM8.32928 20.0756L8.85961 20.6059C8.52853 20.937 8.22799 21.2398 7.95179 21.4505C7.65828 21.6745 7.30594 21.8638 6.861 21.8638L6.861 21.1138L6.861 20.3638C6.86179 20.3638 6.86626 20.3649 6.88584 20.3567C6.9114 20.346 6.96028 20.3203 7.04191 20.258C7.2193 20.1226 7.43788 19.9063 7.79895 19.5452L8.32928 20.0756ZM3.92443 15.6707L4.45475 16.201C4.09368 16.5621 3.87736 16.7807 3.74201 16.9581C3.67973 17.0397 3.65396 17.0886 3.6433 17.1142C3.63513 17.1337 3.63619 17.1382 3.63619 17.139L2.88619 17.139L2.13619 17.139C2.13619 16.6941 2.32554 16.3417 2.54948 16.0482C2.76022 15.772 3.06301 15.4715 3.39409 15.1404L3.92443 15.6707ZM3.92443 18.6073L3.39409 19.1376C3.06301 18.8065 2.76022 18.506 2.54948 18.2298C2.32554 17.9363 2.13619 17.5839 2.13619 17.139L2.88619 17.139L3.63619 17.139C3.63619 17.1398 3.63513 17.1443 3.6433 17.1638C3.65396 17.1894 3.67973 17.2383 3.74201 17.3199C3.87736 17.4973 4.09368 17.7159 4.45475 18.077L3.92443 18.6073ZM15.6707 3.92442L15.1404 3.39409C15.4715 3.06301 15.772 2.76022 16.0482 2.54948C16.3417 2.32554 16.6941 2.13619 17.139 2.13619L17.139 2.88619V3.63619C17.1382 3.63619 17.1337 3.63513 17.1142 3.6433C17.0886 3.65396 17.0397 3.67973 16.9581 3.74201C16.7807 3.87736 16.5621 4.09368 16.201 4.45475L15.6707 3.92442ZM18.6073 3.92442L18.077 4.45475C17.7159 4.09368 17.4973 3.87736 17.3199 3.74201C17.2383 3.67973 17.1894 3.65396 17.1638 3.6433C17.1443 3.63513 17.1398 3.63619 17.139 3.63619V2.88619L17.139 2.13619C17.5839 2.13619 17.9363 2.32554 18.2298 2.54948C18.506 2.76022 18.8065 3.06301 19.1376 3.39409L18.6073 3.92442ZM9.06343 20.0756L9.59376 19.5452L10.3279 20.2794L9.79757 20.8097L9.26724 21.34L8.5331 20.6059L9.06343 20.0756ZM13.4683 20.8097L12.938 20.2794C13.2908 19.9266 13.5194 19.6969 13.6777 19.5071C13.8292 19.3253 13.8669 19.2363 13.8811 19.1833L14.6055 19.3774L15.3299 19.5715C15.2361 19.9216 15.0482 20.2057 14.8297 20.4677C14.6179 20.7218 14.3319 21.0067 13.9986 21.34L13.4683 20.8097ZM13.4683 17.139L13.9986 16.6087C14.3319 16.942 14.6179 17.2269 14.8297 17.481C15.0482 17.743 15.2361 18.0271 15.3299 18.3772L14.6055 18.5713L13.8811 18.7654C13.8669 18.7124 13.8292 18.6234 13.6777 18.4416C13.5194 18.2518 13.2908 18.0222 12.938 17.6693L13.4683 17.139ZM14.6055 19.3774L13.8811 19.1833C13.9177 19.0464 13.9177 18.9023 13.8811 18.7654L14.6055 18.5713L15.3299 18.3772C15.4348 18.7684 15.4348 19.1803 15.3299 19.5715L14.6055 19.3774ZM13.4683 20.8097L13.9986 21.34C13.6653 21.6734 13.3804 21.9593 13.1263 22.1712C12.8643 22.3896 12.5802 22.5776 12.2301 22.6714L12.036 21.9469L11.8419 21.2225C11.8949 21.2083 11.9839 21.1707 12.1657 21.0191C12.3555 20.8609 12.5851 20.6322 12.938 20.2794L13.4683 20.8097ZM9.79757 20.8097L10.3279 20.2794C10.6807 20.6322 10.9104 20.8609 11.1002 21.0191C11.282 21.1707 11.371 21.2083 11.424 21.2225L11.2299 21.9469L11.0357 22.6714C10.6857 22.5776 10.4016 22.3896 10.1396 22.1712C9.88548 21.9593 9.60055 21.6734 9.26724 21.34L9.79757 20.8097ZM12.036 21.9469L12.2301 22.6714C11.8389 22.7762 11.427 22.7762 11.0357 22.6714L11.2299 21.9469L11.424 21.2225C11.5609 21.2592 11.705 21.2592 11.8419 21.2225L12.036 21.9469ZM3.19028 10.5317L3.72061 11.062C3.36778 11.4149 3.13912 11.6445 2.98091 11.8343C2.82932 12.0161 2.79171 12.1051 2.77751 12.1581L2.05306 11.964L1.32862 11.7699C1.42242 11.4198 1.61035 11.1357 1.82884 10.8737C2.04069 10.6196 2.32664 10.3347 2.65995 10.0014L3.19028 10.5317ZM3.19028 14.2024L2.65995 14.7328C2.32664 14.3994 2.04069 14.1145 1.82884 13.8604C1.61035 13.5984 1.42242 13.3143 1.32862 12.9643L2.05306 12.7701L2.77751 12.576C2.79171 12.629 2.82932 12.718 2.98091 12.8998C3.13912 13.0896 3.36778 13.3193 3.72061 13.6721L3.19028 14.2024ZM2.05306 11.964L2.77751 12.1581C2.74083 12.295 2.74083 12.4391 2.77751 12.576L2.05306 12.7701L1.32862 12.9643C1.22379 12.573 1.22379 12.1611 1.32862 11.7699L2.05306 11.964ZM3.19028 10.5317L2.65995 10.0014C2.99326 9.66807 3.27819 9.38212 3.53228 9.17027C3.79432 8.95178 4.07838 8.76385 4.42845 8.67005L4.62257 9.3945L4.81668 10.1189C4.76368 10.1331 4.67467 10.1708 4.49287 10.3223C4.30312 10.4806 4.07344 10.7092 3.72061 11.062L3.19028 10.5317ZM6.861 10.5317L6.33067 11.062C5.97784 10.7092 5.74816 10.4806 5.55841 10.3223C5.37661 10.1708 5.2876 10.1331 5.2346 10.1189L5.42871 9.3945L5.62283 8.67005C5.9729 8.76385 6.25696 8.95178 6.519 9.17027C6.77308 9.38212 7.05802 9.66807 7.39133 10.0014L6.861 10.5317ZM4.62257 9.3945L4.42845 8.67005C4.81968 8.56522 5.2316 8.56523 5.62283 8.67005L5.42871 9.3945L5.2346 10.1189C5.09771 10.0823 4.95357 10.0823 4.81668 10.1189L4.62257 9.3945ZM20.0756 9.06343L20.6059 8.5331L21.34 9.26724L20.8097 9.79757L20.2794 10.3279L19.5452 9.59376L20.0756 9.06343ZM20.8097 13.4683L21.34 13.9986C21.0067 14.3319 20.7218 14.6179 20.4677 14.8297C20.2057 15.0482 19.9216 15.2361 19.5715 15.3299L19.3774 14.6055L19.1833 13.8811C19.2363 13.8669 19.3253 13.8292 19.5071 13.6777C19.6969 13.5194 19.9266 13.2908 20.2794 12.938L20.8097 13.4683ZM17.139 13.4683L17.6693 12.938C18.0222 13.2908 18.2518 13.5194 18.4416 13.6777C18.6234 13.8292 18.7124 13.8669 18.7654 13.8811L18.5713 14.6055L18.3772 15.3299C18.0271 15.2361 17.743 15.0482 17.481 14.8297C17.2269 14.6179 16.942 14.3319 16.6087 13.9986L17.139 13.4683ZM19.3774 14.6055L19.5715 15.3299C19.1803 15.4348 18.7684 15.4348 18.3772 15.3299L18.5713 14.6055L18.7654 13.8811C18.9023 13.9177 19.0464 13.9177 19.1833 13.8811L19.3774 14.6055ZM20.8097 13.4683L20.2794 12.938C20.6322 12.5851 20.8609 12.3555 21.0191 12.1657C21.1707 11.9839 21.2083 11.8949 21.2225 11.8419L21.9469 12.036L22.6714 12.2301C22.5776 12.5802 22.3896 12.8643 22.1712 13.1263C21.9593 13.3804 21.6734 13.6653 21.34 13.9986L20.8097 13.4683ZM20.8097 9.79757L21.34 9.26724C21.6734 9.60055 21.9593 9.88548 22.1712 10.1396C22.3896 10.4016 22.5776 10.6857 22.6714 11.0357L21.9469 11.2299L21.2225 11.424C21.2083 11.371 21.1707 11.282 21.0191 11.1002C20.8609 10.9104 20.6322 10.6807 20.2794 10.3279L20.8097 9.79757ZM21.9469 12.036L21.2225 11.8419C21.2592 11.705 21.2592 11.5609 21.2225 11.424L21.9469 11.2299L22.6714 11.0357C22.7762 11.427 22.7762 11.8389 22.6714 12.2301L21.9469 12.036ZM10.5317 3.19028L10.0014 2.65995C10.3347 2.32664 10.6196 2.04069 10.8737 1.82884C11.1357 1.61035 11.4198 1.42242 11.7699 1.32862L11.964 2.05307L12.1581 2.77751C12.1051 2.79171 12.0161 2.82932 11.8343 2.98091C11.6445 3.13912 11.4149 3.36778 11.062 3.72061L10.5317 3.19028ZM14.2024 3.19028L13.6721 3.72061C13.3193 3.36778 13.0896 3.13912 12.8998 2.98091C12.718 2.82932 12.629 2.79171 12.576 2.77751L12.7701 2.05307L12.9643 1.32862C13.3143 1.42242 13.5984 1.61035 13.8604 1.82884C14.1145 2.04069 14.3994 2.32664 14.7328 2.65995L14.2024 3.19028ZM11.964 2.05307L11.7699 1.32862C12.1611 1.22379 12.573 1.22379 12.9643 1.32862L12.7701 2.05307L12.576 2.77751C12.4391 2.74083 12.295 2.74083 12.1581 2.77751L11.964 2.05307ZM10.5317 3.19028L11.062 3.72061C10.7092 4.07344 10.4806 4.30312 10.3223 4.49287C10.1708 4.67467 10.1331 4.76368 10.1189 4.81668L9.3945 4.62257L8.67005 4.42845C8.76385 4.07838 8.95178 3.79432 9.17027 3.53228C9.38212 3.27819 9.66807 2.99326 10.0014 2.65995L10.5317 3.19028ZM10.5317 6.861L10.0014 7.39133C9.66807 7.05802 9.38212 6.77308 9.17027 6.519C8.95178 6.25696 8.76386 5.9729 8.67005 5.62283L9.3945 5.42871L10.1189 5.2346C10.1331 5.2876 10.1708 5.37661 10.3223 5.55841C10.4806 5.74816 10.7092 5.97784 11.062 6.33067L10.5317 6.861ZM9.3945 4.62257L10.1189 4.81668C10.0823 4.95357 10.0823 5.0977 10.1189 5.2346L9.3945 5.42871L8.67005 5.62283C8.56523 5.2316 8.56522 4.81968 8.67005 4.42845L9.3945 4.62257ZM3.19028 14.2024L3.72061 13.6721L7.02426 16.9757L6.49393 17.5061L5.9636 18.0364L2.65995 14.7328L3.19028 14.2024ZM14.2024 3.19028L14.7328 2.65995L18.0364 5.9636L17.5061 6.49393L16.9757 7.02426L13.6721 3.72061L14.2024 3.19028ZM13.4683 17.139L12.938 17.6693L11.8367 16.5681L12.3671 16.0378L12.8974 15.5075L13.9986 16.6087L13.4683 17.139ZM12.3671 16.0378L11.8367 15.5075L15.5075 11.8367L16.0378 12.3671L16.5681 12.8974L12.8974 16.5681L12.3671 16.0378ZM17.139 13.4683L16.6087 13.9986L15.5075 12.8974L16.0378 12.3671L16.5681 11.8367L17.6693 12.938L17.139 13.4683ZM12.3671 16.0378L11.8367 16.5681L7.43188 12.1633L7.96221 11.6329L8.49254 11.1026L12.8974 15.5075L12.3671 16.0378ZM7.96221 11.6329L7.43188 12.1633L6.33067 11.062L6.861 10.5317L7.39133 10.0014L8.49254 11.1026L7.96221 11.6329ZM11.6329 7.96221L12.1633 8.49254L8.49254 12.1633L7.96221 11.6329L7.43188 11.1026L11.1026 7.43188L11.6329 7.96221ZM16.0378 12.3671L15.5075 12.8974L11.1026 8.49254L11.6329 7.96221L12.1633 7.43188L16.5681 11.8367L16.0378 12.3671ZM11.6329 7.96221L11.1026 8.49254L10.0014 7.39133L10.5317 6.861L11.062 6.33067L12.1633 7.43188L11.6329 7.96221ZM20.0756 9.06343L19.5452 9.59376C19.0496 9.09814 19.0496 8.29458 19.5452 7.79895L20.0756 8.32928L20.6059 8.85961C20.6961 8.76945 20.6961 8.62326 20.6059 8.5331L20.0756 9.06343ZM9.06343 20.0756L8.5331 20.6059C8.62326 20.6961 8.76945 20.6961 8.85961 20.6059L8.32928 20.0756L7.79895 19.5452C8.29457 19.0496 9.09814 19.0496 9.59376 19.5452L9.06343 20.0756Z" fill={currentPage === 'exercises' ? '#A295D5' : '#6E6475'}/>
                                </svg>
                                <div className={`text-xs mt-1 ${currentPage === 'exercises' ? 'text-[#A295D5]' : 'text-[#6E6475]'}`}>운동</div>
                            </button>
                        </div>
                    </nav>

                    {/* 페이지 렌더링 */}
                    <div className="pb-20">
                        {currentPage === 'home' && (
                            <HomePage
                                exercises={exercises}
                                records={records}
                                routines={routines}
                                selectedDate={selectedDate}
                                setSelectedDate={setSelectedDate}
                                addRecord={addRecord}
                                addRecords={addRecords}
                                updateRecord={updateRecord}
                                deleteRecord={deleteRecord}
                                setRecords={setRecords}
                            />
                        )}
                        {currentPage === 'calendar' && (
                            <CalendarPage
                                records={records}
                                exercises={exercises}
                                setCurrentPage={setCurrentPage}
                                setSelectedDate={setSelectedDate}
                            />
                        )}
                        {currentPage === 'routines' && (
                            <RoutinesPage
                                routines={routines}
                                exercises={exercises}
                                addRoutine={addRoutine}
                                setCurrentPage={setCurrentPage}
                                setRoutines={setRoutines}
                            />
                        )}
                        {currentPage === 'exercises' && (
                            <ExercisesPage
                                exercises={exercises}
                                addExercise={addExercise}
                                records={records}
                                setExercises={setExercises}
                            />
                        )}
                    </div>
                </div>
            );
        }

        // 홈 페이지
        function HomePage({ exercises, records, routines, selectedDate, setSelectedDate, addRecord, addRecords, updateRecord, deleteRecord, setRecords }) {
            const [selectedRoutine, setSelectedRoutine] = useState(null);
            const [dateRecords, setDateRecords] = useState([]);
            const [showRoutineModal, setShowRoutineModal] = useState(false);
            const [showExerciseModal, setShowExerciseModal] = useState(false);
            const dateInputRef = React.useRef(null);
            const [checkedSets, setCheckedSets] = useState(loadData(STORAGE_KEYS.CHECKED_SETS) || {});
            const [showOrderModal, setShowOrderModal] = useState(false);
            const [editingRecordIds, setEditingRecordIds] = useState([]);
            const [draggedIndex, setDraggedIndex] = useState(null);
            const longPressTimerRef = React.useRef(null);
            const [showKeyboard, setShowKeyboard] = useState(false);
            const [keyboardTarget, setKeyboardTarget] = useState(null); // {recordId, setIndex, field}
            const [isFirstInput, setIsFirstInput] = useState(true); // 포커스 후 첫 입력 여부
            const scrollPositionRef = React.useRef(0); // 키보드 열기 전 스크롤 위치 저장
            const [selectedExercise, setSelectedExercise] = useState(null); // 히스토리 모달용
            const [showDifficultyModal, setShowDifficultyModal] = useState(false); // 난이도 선택 모달
            const [selectedRecordForDifficulty, setSelectedRecordForDifficulty] = useState(null); // 난이도 설정할 record
            const [showGrowthDetailModal, setShowGrowthDetailModal] = useState(false); // 성장률 상세 모달

            useEffect(() => {
                const recordsForDate = records.filter(r => r.date === selectedDate);
                setDateRecords(recordsForDate);
            }, [records, selectedDate]);

            // 컴포넌트 언마운트 시 키보드 닫기 및 스타일 정리
            useEffect(() => {
                return () => {
                    document.body.style.paddingBottom = '';
                    document.documentElement.style.overscrollBehavior = '';
                    document.body.style.overscrollBehavior = '';
                };
            }, []);

            useEffect(() => {
                saveData(STORAGE_KEYS.CHECKED_SETS, checkedSets);
            }, [checkedSets]);

            // 날짜가 비어있으면 오늘로 자동 복구
            useEffect(() => {
                if (!selectedDate || selectedDate === '') {
                    setSelectedDate(formatDate(new Date()));
                }
            }, [selectedDate]);

            // 볼륨 계산
            const calculateVolume = (sets) => {
                return sets.reduce((total, set) => {
                    const weight = parseFloat(set.weight) || 0;
                    const reps = parseFloat(set.reps) || 0;
                    return total + (weight * reps);
                }, 0);
            };

            // 운동 히스토리 조회
            const getExerciseHistory = (exerciseId) => {
                return records
                    .filter(r => r.exerciseId === exerciseId && r.sets && r.sets.length > 0)
                    .sort((a, b) => b.date.localeCompare(a.date));
            };

            // 각 운동의 직전 기록 대비 성장률 계산
            const getExerciseGrowth = (exerciseId) => {
                const todayRecord = dateRecords.find(r => r.exerciseId === exerciseId);
                if (!todayRecord || !todayRecord.sets || todayRecord.sets.length === 0) return null;

                const previousRecords = records
                    .filter(r => r.exerciseId === exerciseId && r.date < selectedDate && r.sets && r.sets.length > 0)
                    .sort((a, b) => b.date.localeCompare(a.date));

                if (previousRecords.length === 0) return null;

                const todayVolume = calculateVolume(todayRecord.sets);
                const previousVolume = calculateVolume(previousRecords[0].sets);

                if (previousVolume === 0) return null;

                const growth = ((todayVolume - previousVolume) / previousVolume) * 100;
                return { growth, previousDate: previousRecords[0].date };
            };

            // 루틴 전체 성장률 계산 (각 운동별 최근 기록 비교)
            const getRoutineGrowth = () => {
                // 1. 현재 날짜의 세트가 있고 볼륨이 0이 아닌 운동들 필터링
                const recordsWithSets = dateRecords.filter(r => {
                    if (!r.sets || r.sets.length === 0) return false;
                    const volume = calculateVolume(r.sets);
                    return volume > 0;
                });

                if (recordsWithSets.length === 0) return null;

                // 2. 각 운동별로 가장 최근 기록 찾기 및 비교
                const comparisons = [];
                let totalCurrentVolume = 0;
                let totalPreviousVolume = 0;
                let mostRecentComparisonDate = null;

                for (const currentRecord of recordsWithSets) {
                    const currentVolume = calculateVolume(currentRecord.sets);

                    // 과거 기록 중 가장 최근 기록 찾기
                    const previousRecords = records
                        .filter(r =>
                            r.exerciseId === currentRecord.exerciseId &&
                            r.date < selectedDate &&
                            r.sets &&
                            r.sets.length > 0
                        )
                        .sort((a, b) => b.date.localeCompare(a.date));

                    if (previousRecords.length === 0) continue;

                    const previousRecord = previousRecords[0];
                    const previousVolume = calculateVolume(previousRecord.sets);

                    if (previousVolume === 0) continue;

                    totalCurrentVolume += currentVolume;
                    totalPreviousVolume += previousVolume;

                    // 비교 데이터 저장 (모달에서 사용)
                    comparisons.push({
                        exerciseId: currentRecord.exerciseId,
                        currentRecord: currentRecord,
                        previousRecord: previousRecord,
                        currentVolume: currentVolume,
                        previousVolume: previousVolume,
                        growth: ((currentVolume - previousVolume) / previousVolume) * 100
                    });

                    // 가장 최근 비교 날짜 추적
                    if (!mostRecentComparisonDate || previousRecord.date > mostRecentComparisonDate) {
                        mostRecentComparisonDate = previousRecord.date;
                    }
                }

                if (comparisons.length === 0 || totalPreviousVolume === 0) return null;

                const growth = ((totalCurrentVolume - totalPreviousVolume) / totalPreviousVolume) * 100;

                return {
                    growth,
                    previousDate: mostRecentComparisonDate,
                    commonCount: comparisons.length,
                    comparisons: comparisons
                };
            };

            // 성장률에 따른 메시지 반환
            const getGrowthMessage = (growth) => {
                if (growth < -5) return '오늘은 퇴보하는 날이었네요';
                if (growth >= -5 && growth <= 0) return '오늘은 성장하지 못했습니다';
                if (growth > 0 && growth < 1.5) return '미세하지만 좋은 시도였습니다';
                if (growth >= 1.5 && growth < 3) return '근육이 성장하는 최적의 구간!';
                if (growth >= 3 && growth < 5) return '근육에 강한 자극을 받았습니다.';
                if (growth >= 5) return '헉! 너무 무리하시는거 아니에요?';
                return '';
            };

            const routineGrowth = getRoutineGrowth();

            const handleRoutineSelect = (routine) => {
                setSelectedRoutine(routine);
                // 루틴의 운동들을 오늘 기록에 한 번에 추가
                const newRecords = routine.exerciseIds
                    .filter(exerciseId => !dateRecords.find(r => r.exerciseId === exerciseId))
                    .map(exerciseId => {
                        // 각 운동의 직전 기록 찾기
                        const previousRecords = records
                            .filter(r => r.exerciseId === exerciseId && r.date < selectedDate && r.sets && r.sets.length > 0)
                            .sort((a, b) => b.date.localeCompare(a.date));

                        let defaultSets = [];

                        // 직전 기록이 있으면 해당 세트 수만큼 복사
                        if (previousRecords.length > 0) {
                            defaultSets = previousRecords[0].sets.map(set => ({
                                weight: set.weight,
                                reps: set.reps
                            }));
                        }
                        // 직전 기록이 없으면 빈 배열 (세트 없음)

                        return {
                            date: selectedDate,
                            exerciseId: exerciseId,
                            sets: defaultSets
                        };
                    });

                if (newRecords.length > 0) {
                    addRecords(newRecords);
                }
                setShowRoutineModal(false);
            };

            const handleExerciseSelect = (exerciseId) => {
                const exists = dateRecords.find(r => r.exerciseId === exerciseId);
                if (!exists) {
                    // 직전 기록 찾기
                    const previousRecords = records
                        .filter(r => r.exerciseId === exerciseId && r.date < selectedDate && r.sets && r.sets.length > 0)
                        .sort((a, b) => b.date.localeCompare(a.date));

                    let defaultSets = [];

                    // 직전 기록이 있으면 해당 세트 수만큼 복사
                    if (previousRecords.length > 0) {
                        defaultSets = previousRecords[0].sets.map(set => ({
                            weight: set.weight,
                            reps: set.reps
                        }));
                    }
                    // 직전 기록이 없으면 빈 배열 (세트 없음)

                    addRecord({
                        date: selectedDate,
                        exerciseId: exerciseId,
                        sets: defaultSets
                    });
                }
                setShowExerciseModal(false);
            };

            const addSet = (recordId) => {
                const record = dateRecords.find(r => r.id === recordId);
                let defaultSet = { weight: 0, reps: 0 };

                // 직전 기록 찾기
                const previousRecords = records
                    .filter(r => r.exerciseId === record.exerciseId && r.date < selectedDate && r.sets && r.sets.length > 0)
                    .sort((a, b) => b.date.localeCompare(a.date));

                // 추가할 세트의 인덱스 (현재 세트 개수 = 다음 세트 인덱스)
                const nextSetIndex = record.sets ? record.sets.length : 0;

                // 직전 기록에서 해당 세트가 있으면 가져오기
                if (previousRecords.length > 0 && previousRecords[0].sets[nextSetIndex]) {
                    defaultSet = {
                        weight: previousRecords[0].sets[nextSetIndex].weight,
                        reps: previousRecords[0].sets[nextSetIndex].reps
                    };
                } else if (record.sets && record.sets.length > 0) {
                    // 직전 기록에 해당 세트가 없으면 마지막 세트 복사
                    const lastSet = record.sets[record.sets.length - 1];
                    defaultSet = { weight: lastSet.weight, reps: lastSet.reps };
                }

                const newSets = [...(record.sets || []), defaultSet];
                updateRecord(recordId, { sets: newSets });
            };

            const updateSet = (recordId, setIndex, field, value) => {
                const record = dateRecords.find(r => r.id === recordId);
                const newSets = [...record.sets];
                newSets[setIndex] = { ...newSets[setIndex], [field]: value };
                updateRecord(recordId, { sets: newSets });
            };

            const removeSet = (recordId, setIndex) => {
                const record = dateRecords.find(r => r.id === recordId);
                const newSets = record.sets.filter((_, i) => i !== setIndex);
                updateRecord(recordId, { sets: newSets });
            };

            const toggleSetCheck = (recordId, setIndex) => {
                const key = `${recordId}-${setIndex}`;
                setCheckedSets(prev => ({
                    ...prev,
                    [key]: !prev[key]
                }));
            };

            // 길게 누르기 핸들러
            const handleLongPressStart = () => {
                longPressTimerRef.current = setTimeout(() => {
                    if (dateRecords.length > 1) {
                        setEditingRecordIds(dateRecords.map(r => r.id));
                        setShowOrderModal(true);
                    }
                }, 500); // 500ms 길게 누르기
            };

            const handleLongPressEnd = () => {
                if (longPressTimerRef.current) {
                    clearTimeout(longPressTimerRef.current);
                    longPressTimerRef.current = null;
                }
            };

            // 드래그 앤 드롭 핸들러
            const handleDragStart = (index) => {
                setDraggedIndex(index);
            };

            const handleDragOver = (e, index) => {
                e.preventDefault();
                if (draggedIndex === null || draggedIndex === index) return;

                const newIds = [...editingRecordIds];
                const draggedItem = newIds[draggedIndex];

                newIds.splice(draggedIndex, 1);
                newIds.splice(index, 0, draggedItem);

                setEditingRecordIds(newIds);
                setDraggedIndex(index);
            };

            const handleDragEnd = () => {
                setDraggedIndex(null);
            };

            // 순서 저장
            const saveRecordOrder = () => {
                // records 배열에서 현재 날짜의 레코드들을 새 순서로 업데이트
                const otherRecords = records.filter(r => r.date !== selectedDate);
                const reorderedRecords = editingRecordIds.map(id =>
                    records.find(r => r.id === id)
                );

                // 전체 records 배열을 업데이트 (다른 날짜 레코드 + 재정렬된 오늘 레코드)
                const newRecords = [...otherRecords, ...reorderedRecords];

                // 부모 컴포넌트의 records 상태를 직접 업데이트 (새로고침 없이)
                setRecords(newRecords);

                // 모달 닫기
                setShowOrderModal(false);
            };

            // 커스텀 키보드 핸들러
            const openKeyboard = (recordId, setIndex, field, event) => {
                setKeyboardTarget({ recordId, setIndex, field });
                setShowKeyboard(true);
                setIsFirstInput(true); // 포커스 시 첫 입력 상태로 설정

                // overscroll(경계 넘어가는 bounce) 방지 - 일반 스크롤은 허용됨
                document.documentElement.style.overscrollBehavior = 'none';
                document.body.style.overscrollBehavior = 'none';

                // 키보드가 렌더링된 후 실제 높이 측정 및 padding 적용
                setTimeout(() => {
                    const keyboardElement = document.querySelector('.fixed.bottom-0.z-50');
                    if (keyboardElement) {
                        const keyboardHeight = keyboardElement.offsetHeight;
                        // 키보드 높이 + 여유 공간 8px (최소화)
                        document.body.style.paddingBottom = `${keyboardHeight + 8}px`;
                    }

                    // 입력 필드로 스크롤
                    if (event && event.target) {
                        const inputElement = event.target;
                        const inputRect = inputElement.getBoundingClientRect();
                        const keyboardTop = keyboardElement ? window.innerHeight - keyboardElement.offsetHeight : window.innerHeight;

                        // 입력 필드가 키보드에 가려지면 스크롤
                        if (inputRect.bottom > keyboardTop - 50) {
                            const scrollAmount = inputRect.bottom - (keyboardTop - 50);
                            window.scrollBy({
                                top: scrollAmount,
                                behavior: 'smooth'
                            });
                        }
                    }
                }, 150);
            };

            const closeKeyboard = () => {
                // 현재 필드 값 정리 (마지막이 "."이면 제거)
                if (keyboardTarget) {
                    const { recordId, setIndex, field } = keyboardTarget;
                    const record = dateRecords.find(r => r.id === recordId);
                    const currentValue = String(record?.sets?.[setIndex]?.[field] || '');

                    if (currentValue.endsWith('.')) {
                        updateRecord(recordId, {
                            sets: record.sets.map((set, idx) =>
                                idx === setIndex ? { ...set, [field]: currentValue.slice(0, -1) || '0' } : set
                            )
                        });
                    }
                }

                setShowKeyboard(false);
                setKeyboardTarget(null);

                // 패딩 및 overscroll 제거
                document.body.style.paddingBottom = '';
                document.documentElement.style.overscrollBehavior = '';
                document.body.style.overscrollBehavior = '';
            };

            const handleKeyboardInput = (value) => {
                if (!keyboardTarget) return;

                const { recordId, setIndex, field } = keyboardTarget;
                const record = dateRecords.find(r => r.id === recordId);
                const currentValue = String(record.sets[setIndex][field] || '');

                if (value === 'backspace') {
                    const newValue = currentValue.slice(0, -1);
                    updateSet(recordId, setIndex, field, newValue || '0');
                    setIsFirstInput(false); // backspace는 첫 입력 아님
                } else if (value === 'next') {
                    // 현재 필드 값 정리 (마지막이 "."이면 제거)
                    if (currentValue.endsWith('.')) {
                        updateSet(recordId, setIndex, field, currentValue.slice(0, -1) || '0');
                    }

                    // 다음 입력으로 이동
                    if (field === 'weight') {
                        setKeyboardTarget({ recordId, setIndex, field: 'reps' });
                        setIsFirstInput(true); // 다른 필드로 이동 시 첫 입력 상태
                    } else {
                        // 다음 세트나 닫기
                        const nextSetIndex = setIndex + 1;
                        if (record.sets[nextSetIndex]) {
                            setKeyboardTarget({ recordId, setIndex: nextSetIndex, field: 'weight' });
                            setIsFirstInput(true); // 다음 세트로 이동 시 첫 입력 상태
                        } else {
                            closeKeyboard();
                        }
                    }
                } else if (value === '+1' || value === '-1' || value === '+5' || value === '-5') {
                    const currentNum = parseFloat(currentValue) || 0;
                    const delta = parseFloat(value);
                    let newValue = Math.max(0, currentNum + delta);

                    // 최대값 제한
                    const maxValue = field === 'weight' ? LIMITS.weightMax : LIMITS.repsMax;
                    newValue = Math.min(newValue, maxValue);

                    updateSet(recordId, setIndex, field, String(newValue));
                    setIsFirstInput(false); // +/- 버튼은 첫 입력 아님
                } else {
                    // 숫자나 소수점 입력
                    const maxLength = field === 'weight' ? LIMITS.weightLen : LIMITS.repsLen;
                    const isNumberKey = /^[0-9]$/.test(value);

                    // 첫 입력이고 숫자 키이고 값이 있으면 → 기존 값 지우고 새로 시작 (검증 전에 먼저 체크)
                    let finalValue;
                    if (isFirstInput && isNumberKey && currentValue !== '' && currentValue !== '0') {
                        finalValue = value;
                    } else {
                        // 첫 입력이 아니면 검증 로직 적용

                        // 횟수(reps)에 소수점 입력 방지
                        if (value === '.' && field === 'reps') {
                            return; // 횟수는 소수점 불가
                        }

                        // 소수점이 맨 앞에 오지 않게
                        if (value === '.' && (currentValue === '' || currentValue === '0')) {
                            return; // .3 같은 입력 방지
                        }

                        // 소수점 중복 입력 방지
                        if (value === '.' && currentValue.includes('.')) {
                            return; // 이미 소수점이 있으면 무시
                        }

                        // 소수점 자릿수 제한 (weight만)
                        if (field === 'weight' && currentValue.includes('.')) {
                            const decimalPart = currentValue.split('.')[1];
                            if (decimalPart && decimalPart.length >= LIMITS.weightDecimals && value !== 'backspace') {
                                return; // 소수점 이하 자릿수 초과 방지
                            }
                        }

                        finalValue = currentValue === '0' ? value : currentValue + value;
                    }

                    // 글자수 제한 체크
                    if (finalValue.length > maxLength) {
                        return; // 글자수 초과 시 무시
                    }

                    const numValue = parseFloat(finalValue) || 0;

                    // 최대값 제한
                    const maxValue = field === 'weight' ? LIMITS.weightMax : LIMITS.repsMax;
                    if (numValue > maxValue) {
                        return; // 최대값 초과 시 무시
                    }

                    updateSet(recordId, setIndex, field, finalValue);
                    setIsFirstInput(false); // 입력 후 첫 입력 아님으로 변경
                }
            };

            const getCurrentValue = () => {
                if (!keyboardTarget) return '';
                const { recordId, setIndex, field } = keyboardTarget;
                const record = dateRecords.find(r => r.id === recordId);
                return record?.sets?.[setIndex]?.[field] || '';
            };

            return (
                <div className="p-4 pb-2">
                    {/* 날짜 표시 */}
                    <div className="mb-4 flex items-center justify-between">
                        <div className="flex items-center gap-2">
                            <h1 className="text-2xl font-bold text-gray-800">
                                {formatDateKorean(selectedDate)}
                            </h1>
                            {selectedDate === formatDate(new Date()) ? (
                                <span
                                    className="px-2 py-1 text-xs font-medium rounded"
                                    style={{ color: 'rgb(162, 149, 213)', backgroundColor: 'rgba(162, 149, 213, 0.1)' }}
                                >
                                    Today
                                </span>
                            ) : (
                                <button
                                    onClick={() => setSelectedDate(formatDate(new Date()))}
                                    className="px-2 py-1 text-xs font-medium rounded transition-colors"
                                    style={{ color: 'rgb(156, 163, 175)', backgroundColor: 'rgb(243, 244, 246)' }}
                                    onMouseEnter={(e) => e.currentTarget.style.backgroundColor = 'rgb(229, 231, 235)'}
                                    onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'rgb(243, 244, 246)'}
                                >
                                    Today
                                </button>
                            )}
                        </div>
                        <div className="flex items-center gap-0">
                            <button
                                onClick={() => dateInputRef.current?.showPicker()}
                                className="p-2"
                            >
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M2 12C2 8.22876 2 6.34315 3.17157 5.17157C4.34315 4 6.22876 4 10 4H14C17.7712 4 19.6569 4 20.8284 5.17157C22 6.34315 22 8.22876 22 12V14C22 17.7712 22 19.6569 20.8284 20.8284C19.6569 22 17.7712 22 14 22H10C6.22876 22 4.34315 22 3.17157 20.8284C2 19.6569 2 17.7712 2 14V12Z" stroke="#6E6475" strokeWidth="1.5"/>
                                    <path d="M7 4V2.5" stroke="#6E6475" strokeWidth="1.5" strokeLinecap="round"/>
                                    <path d="M17 4V2.5" stroke="#6E6475" strokeWidth="1.5" strokeLinecap="round"/>
                                    <path d="M2.5 9H21.5" stroke="#6E6475" strokeWidth="1.5" strokeLinecap="round"/>
                                    <path d="M18 17C18 17.5523 17.5523 18 17 18C16.4477 18 16 17.5523 16 17C16 16.4477 16.4477 16 17 16C17.5523 16 18 16.4477 18 17Z" fill="#6E6475"/>
                                    <path d="M18 13C18 13.5523 17.5523 14 17 14C16.4477 14 16 13.5523 16 13C16 12.4477 16.4477 12 17 12C17.5523 12 18 12.4477 18 13Z" fill="#6E6475"/>
                                    <path d="M13 17C13 17.5523 12.5523 18 12 18C11.4477 18 11 17.5523 11 17C11 16.4477 11.4477 16 12 16C12.5523 16 13 16.4477 13 17Z" fill="#6E6475"/>
                                    <path d="M13 13C13 13.5523 12.5523 14 12 14C11.4477 14 11 13.5523 11 13C11 12.4477 11.4477 12 12 12C12.5523 12 13 12.4477 13 13Z" fill="#6E6475"/>
                                    <path d="M8 17C8 17.5523 7.55228 18 7 18C6.44772 18 6 17.5523 6 17C6 16.4477 6.44772 16 7 16C7.55228 16 8 16.4477 8 17Z" fill="#6E6475"/>
                                    <path d="M8 13C8 13.5523 7.55228 14 7 14C6.44772 14 6 13.5523 6 13C6 12.4477 6.44772 12 7 12C7.55228 12 8 12.4477 8 13Z" fill="#6E6475"/>
                                </svg>
                            </button>
                            <button
                                onClick={() => {
                                    if (dateRecords.length > 1) {
                                        setEditingRecordIds(dateRecords.map(r => r.id));
                                        setShowOrderModal(true);
                                    }
                                }}
                                className="p-2"
                            >
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M4 6H20M4 12.5H20M4 19H20" stroke="#6E6475" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        </div>
                        <input
                            ref={dateInputRef}
                            type="date"
                            value={selectedDate}
                            max={formatDate(new Date())}
                            onChange={(e) => setSelectedDate(e.target.value)}
                            className="hidden"
                        />
                    </div>

                    {/* 루틴 성장률 */}
                    {routineGrowth && (
                        <div
                            onClick={() => setShowGrowthDetailModal(true)}
                            className={`mb-4 p-4 rounded-lg border cursor-pointer ${
                            routineGrowth.growth > 0
                                ? 'bg-[#FAFFFB] border-[#78D2A8]'
                                : routineGrowth.growth === 0
                                    ? 'bg-[#F3F1FA] border-[#D4CDEB]'
                                    : 'bg-[#FFF9FA] border-[#F06B8ACC]'
                        }`}>
                            <div className="flex items-center justify-between mb-1">
                                <div className="text-base font-medium text-gray-700">
                                    {getGrowthMessage(routineGrowth.growth)}
                                </div>
                                <span className={`text-lg font-bold ml-3 ${
                                    routineGrowth.growth > 0
                                        ? 'text-[#2D9C61]'
                                        : routineGrowth.growth === 0
                                            ? 'text-[#847DC4]'
                                            : 'text-[#E75D7DCC]'
                                }`}>
                                    {routineGrowth.growth >= 0 ? '+' : ''}{routineGrowth.growth.toFixed(1)}%
                                </span>
                            </div>
                            <div className="text-xs text-gray-500">
                                vs {formatDateKorean(routineGrowth.previousDate)} · {routineGrowth.commonCount}개 운동 비교
                            </div>
                        </div>
                    )}

                    {/* 운동 추가 버튼 */}
                    <div className="flex gap-2 mb-4">
                        <button
                            onClick={() => setShowRoutineModal(true)}
                            className="flex-1 bg-white text-[#847DC4] py-3 rounded font-normal text-sm border border-[#8881CE]"
                        >
                            루틴 선택
                        </button>
                        <button
                            onClick={() => setShowExerciseModal(true)}
                            className="flex-1 bg-[#A295D5] text-white py-3 rounded font-normal text-sm"
                        >
                            운동 추가
                        </button>
                    </div>

                    {/* 오늘의 운동 기록 */}
                    <div className="space-y-4">
                        {dateRecords.map(record => {
                            const exercise = exercises.find(e => e.id === record.exerciseId);
                            if (!exercise) return null;

                            const growth = getExerciseGrowth(exercise.id);

                            return (
                                <div key={record.id} className="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                                    {/* 운동 헤더 */}
                                    <div className="flex items-center mb-3 gap-2 min-w-0">
                                        <h3 className="text-lg font-bold text-gray-800 truncate shrink min-w-0">{exercise.name}</h3>
                                        {(() => {
                                            // 현재 난이도가 있으면 표시 (보라색 - 사용자가 선택함)
                                            if (record.difficulty) {
                                                const diffInfo = getDifficultyInfo(record.difficulty);
                                                return (
                                                    <button
                                                        onClick={() => {
                                                            setSelectedRecordForDifficulty(record);
                                                            setShowDifficultyModal(true);
                                                        }}
                                                        className="ml-auto flex items-center gap-1 pl-1 pr-1.5 bg-white rounded-full border border-[#A295D5] text-[#A295D5] cursor-pointer hover:opacity-80 shrink-0"
                                                        style={{height: '28px'}}
                                                        dangerouslySetInnerHTML={{__html: diffInfo.icon + '<span class="text-sm font-normal max-[450px]:hidden">' + diffInfo.text + '</span>'}}
                                                    />
                                                );
                                            } else {
                                                // 현재 난이도 없으면 직전 운동 난이도 찾기
                                                const history = getExerciseHistory(record.exerciseId);
                                                const previousRecord = history.find(r => r.date < selectedDate && r.difficulty);

                                                if (previousRecord) {
                                                    // 직전 운동 난이도 표시 (회색 - 불러온 값)
                                                    const diffInfo = getDifficultyInfo(previousRecord.difficulty);
                                                    return (
                                                        <button
                                                            onClick={() => {
                                                                setSelectedRecordForDifficulty(record);
                                                                setShowDifficultyModal(true);
                                                            }}
                                                            className="ml-auto flex items-center gap-1 pl-1 pr-1.5 bg-white rounded-full border border-gray-200 text-gray-400 cursor-pointer hover:opacity-80 shrink-0"
                                                            style={{height: '28px'}}
                                                            dangerouslySetInnerHTML={{__html: diffInfo.icon + '<span class="text-sm font-normal max-[450px]:hidden">' + diffInfo.text + '</span>'}}
                                                        />
                                                    );
                                                } else {
                                                    // 직전 운동도 없으면 플레이스홀더 (실선)
                                                    return (
                                                        <button
                                                            onClick={() => {
                                                                setSelectedRecordForDifficulty(record);
                                                                setShowDifficultyModal(true);
                                                            }}
                                                            className="ml-auto flex items-center gap-1 px-2 bg-white rounded-full border border-gray-300 text-gray-400 cursor-pointer hover:border-gray-400 hover:text-gray-500 shrink-0"
                                                            style={{height: '28px'}}
                                                        >
                                                            <span className="text-sm font-normal max-[450px]:hidden">난이도</span>
                                                        </button>
                                                    );
                                                }
                                            }
                                        })()}
                                        {growth && (
                                            <button
                                                onClick={() => setSelectedExercise(exercise)}
                                                className={`ml-2 flex items-center px-1 py-0.5 rounded-full border cursor-pointer hover:opacity-80 shrink-0 ${
                                                growth.growth > 0
                                                    ? 'bg-[#FAFFFB] border-[#78D2A8] text-[#2D9C61]'
                                                    : growth.growth === 0
                                                        ? 'bg-[#F3F1FA] border-[#D4CDEB] text-[#847DC4]'
                                                        : 'bg-[#FFF9FA] border-[#F06B8ACC] text-[#E75D7DCC]'
                                            }`}
                                                style={{height: '28px'}}
                                            >
                                                <span className="text-sm font-bold">
                                                    {growth.growth >= 0 ? '+' : ''}{growth.growth.toFixed(1)}%
                                                </span>
                                            </button>
                                        )}
                                        {!growth && (
                                            <div className="ml-auto"></div>
                                        )}
                                    </div>

                                    {/* 세트 입력 */}
                                    <div className="space-y-2">
                                        {(record.sets || []).map((set, index) => {
                                            const checkKey = `${record.id}-${index}`;
                                            const isChecked = checkedSets[checkKey] || false;

                                            return (
                                                <div key={index} className="flex items-center gap-1.5">
                                                    <span className="text-sm text-gray-400 flex-shrink-0" style={{minWidth: '48px'}}>세트 {index + 1}</span>
                                                    <input
                                                        type="text"
                                                        inputMode="none"
                                                        value={set.weight || ''}
                                                        onFocus={(e) => openKeyboard(record.id, index, 'weight', e)}
                                                        readOnly
                                                        placeholder="무게"
                                                        className={`flex-1 min-w-0 px-2 py-1 border rounded text-center focus:outline-none focus:border-[#A295D5] focus:border-2 focus:bg-[#F3F1FA] ${
                                                            keyboardTarget?.recordId === record.id &&
                                                            keyboardTarget?.setIndex === index &&
                                                            keyboardTarget?.field === 'weight'
                                                                ? 'border-[#A295D5] border-2 bg-[#F3F1FA]'
                                                                : 'border-gray-300'
                                                        }`}
                                                        style={{maxWidth: '70px'}}
                                                    />
                                                    <span className="text-gray-400 text-sm flex-shrink-0">kg</span>
                                                    <input
                                                        type="text"
                                                        inputMode="none"
                                                        value={set.reps || ''}
                                                        onFocus={(e) => openKeyboard(record.id, index, 'reps', e)}
                                                        readOnly
                                                        placeholder="횟수"
                                                        className={`flex-1 min-w-0 px-2 py-1 border rounded text-center focus:outline-none focus:border-[#A295D5] focus:border-2 focus:bg-[#F3F1FA] ${
                                                            keyboardTarget?.recordId === record.id &&
                                                            keyboardTarget?.setIndex === index &&
                                                            keyboardTarget?.field === 'reps'
                                                                ? 'border-[#A295D5] border-2 bg-[#F3F1FA]'
                                                                : 'border-gray-300'
                                                        }`}
                                                        style={{maxWidth: '70px'}}
                                                    />
                                                    <span className="text-gray-400 text-sm flex-shrink-0">회</span>
                                                    <button
                                                        onClick={() => toggleSetCheck(record.id, index)}
                                                        className="flex-shrink-0 ml-auto"
                                                    >
                                                        <div className={`w-[34px] h-[28px] rounded border flex items-center justify-center ${
                                                            isChecked
                                                                ? 'bg-[#A295D5] border-[#A295D5]'
                                                                : 'border-gray-300'
                                                        }`}>
                                                            <svg className={`w-5 h-5 ${isChecked ? 'text-white' : 'text-gray-200'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M5 13l4 4L19 7" />
                                                            </svg>
                                                        </div>
                                                    </button>
                                                </div>
                                            );
                                        })}
                                    </div>

                                    {/* 세트 추가/삭제 버튼 */}
                                    <div className="flex gap-2 mt-3">
                                        <button
                                            onClick={() => removeSet(record.id, (record.sets || []).length - 1)}
                                            disabled={(record.sets || []).length === 0}
                                            className="flex-1 py-2 border border-gray-300 rounded text-gray-500 text-sm disabled:opacity-30"
                                        >
                                            삭제
                                        </button>
                                        <button
                                            onClick={() => addSet(record.id)}
                                            className="flex-1 py-2 border border-gray-300 rounded text-gray-500 text-sm"
                                        >
                                            추가
                                        </button>
                                    </div>
                                </div>
                            );
                        })}

                        {dateRecords.length === 0 && (
                            <div className="text-center py-12">
                                <img src="home.png" alt="운동 기록 없음" className="mx-auto mb-4" style={{maxWidth: '200px'}} />
                                <p className="text-gray-400">루틴을 선택하거나 운동을 추가하세요</p>
                            </div>
                        )}
                    </div>

                    {/* 루틴 선택 모달 */}
                    {showRoutineModal && (
                        <Modal onClose={() => setShowRoutineModal(false)} title="루틴 선택">
                            <div className="space-y-2">
                                {routines.map(routine => (
                                    <button
                                        key={routine.id}
                                        onClick={() => handleRoutineSelect(routine)}
                                        className="w-full p-4 bg-white border border-gray-300 rounded-lg hover:bg-[#F3F1FA] text-left"
                                    >
                                        <div className="font-bold text-gray-800">{routine.name}</div>
                                        <div className="text-sm text-gray-500 mt-1">
                                            {routine.exerciseIds.map(id => {
                                                const ex = exercises.find(e => e.id === id);
                                                return ex ? ex.name : '';
                                            }).join(', ')}
                                        </div>
                                    </button>
                                ))}
                                {routines.length === 0 && (
                                    <p className="text-center text-gray-400 py-8">저장된 루틴이 없습니다</p>
                                )}
                            </div>
                        </Modal>
                    )}

                    {/* 운동 선택 모달 */}
                    {showExerciseModal && (
                        <ExerciseSelectModal
                            exercises={exercises}
                            onSelect={handleExerciseSelect}
                            onClose={() => setShowExerciseModal(false)}
                        />
                    )}

                    {/* 운동 순서 변경 모달 */}
                    {showOrderModal && (
                        <Modal onClose={() => setShowOrderModal(false)} title="운동 순서 변경">
                            <div className="mb-3 text-sm text-gray-600">
                                드래그해서 순서를 변경하세요
                            </div>
                            <div className="space-y-3">
                                {editingRecordIds.map((recordId, index) => {
                                    const record = records.find(r => r.id === recordId);
                                    const exercise = exercises.find(e => e.id === record?.exerciseId);
                                    if (!exercise) return null;

                                    return (
                                        <div
                                            key={recordId}
                                            draggable
                                            onDragStart={() => handleDragStart(index)}
                                            onDragOver={(e) => handleDragOver(e, index)}
                                            onDragEnd={handleDragEnd}
                                            className={`bg-gray-50 p-4 rounded-lg flex items-center gap-3 cursor-move touch-none ${
                                                draggedIndex === index ? 'opacity-50' : ''
                                            }`}
                                        >
                                            <div className="text-sm text-gray-400">#{index + 1}</div>
                                            <div className="flex-1">
                                                <div className="font-medium text-gray-800">{exercise.name}</div>
                                                <div className="text-xs text-gray-500">{exercise.tag}</div>
                                            </div>
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    if (window.confirm(`"${exercise.name}" 운동을 삭제하시겠습니까?`)) {
                                                        deleteRecord(recordId);
                                                        setEditingRecordIds(editingRecordIds.filter(id => id !== recordId));
                                                        if (editingRecordIds.length <= 2) {
                                                            setShowOrderModal(false);
                                                        }
                                                    }
                                                }}
                                                className="p-2 hover:bg-gray-200 rounded"
                                            >
                                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M13.75 10C13.75 10.1658 13.6842 10.3247 13.5669 10.4419C13.4497 10.5592 13.2908 10.625 13.125 10.625H6.875C6.70924 10.625 6.55027 10.5592 6.43306 10.4419C6.31585 10.3247 6.25 10.1658 6.25 10C6.25 9.83424 6.31585 9.67527 6.43306 9.55806C6.55027 9.44085 6.70924 9.375 6.875 9.375H13.125C13.2908 9.375 13.4497 9.44085 13.5669 9.55806C13.6842 9.67527 13.75 9.83424 13.75 10ZM18.125 10C18.125 11.607 17.6485 13.1779 16.7557 14.514C15.8629 15.8502 14.594 16.8916 13.1093 17.5065C11.6247 18.1215 9.99099 18.2824 8.41489 17.9689C6.8388 17.6554 5.39106 16.8815 4.25476 15.7452C3.11846 14.6089 2.34463 13.1612 2.03112 11.5851C1.71762 10.009 1.87852 8.37535 2.49348 6.8907C3.10844 5.40605 4.14985 4.1371 5.486 3.24431C6.82214 2.35152 8.39303 1.875 10 1.875C12.1542 1.87727 14.2195 2.73403 15.7427 4.25727C17.266 5.78051 18.1227 7.84581 18.125 10ZM16.875 10C16.875 8.64025 16.4718 7.31104 15.7164 6.18045C14.9609 5.04987 13.8872 4.16868 12.631 3.64833C11.3747 3.12798 9.99238 2.99183 8.65876 3.2571C7.32514 3.52237 6.10013 4.17715 5.13864 5.13864C4.17716 6.10013 3.52238 7.32513 3.2571 8.65875C2.99183 9.99237 3.12798 11.3747 3.64833 12.6309C4.16868 13.8872 5.04987 14.9609 6.18046 15.7164C7.31105 16.4718 8.64026 16.875 10 16.875C11.8227 16.8729 13.5702 16.1479 14.8591 14.8591C16.1479 13.5702 16.8729 11.8227 16.875 10Z" fill="#C1BBC3"/>
                                                </svg>
                                            </button>
                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M4 6H20M4 12.5H20M4 19H20" stroke="#6E6475" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </div>
                                    );
                                })}
                                <button
                                    onClick={saveRecordOrder}
                                    className="w-full bg-[#A295D5] text-white py-3 rounded-lg font-medium hover:bg-[#8E7FC4] mt-4"
                                >
                                    저장
                                </button>
                            </div>
                        </Modal>
                    )}

                    {/* 운동 히스토리 모달 */}
                    {selectedExercise && (
                        <Modal onClose={() => setSelectedExercise(null)} title={<span className="inline-flex items-center"><span className="text-gray-800">{`${selectedExercise.name} 히스토리`}</span></span>}>
                            <div className="space-y-4 max-h-[600px] overflow-y-auto">
                                {getExerciseHistory(selectedExercise.id).map(record => (
                                    <div key={record.id} className="bg-gray-50 p-4 rounded-lg">
                                        <div className="font-bold text-gray-800 mb-2">
                                            {formatDateKorean(record.date)}
                                        </div>
                                        <div className="space-y-1">
                                            {record.sets.map((set, index) => (
                                                <div key={index} className="text-sm text-gray-700">
                                                    세트 {index + 1}: {set.weight}kg × {set.reps}회
                                                </div>
                                            ))}
                                        </div>
                                        <div className="text-sm text-gray-500 mt-2">
                                            총 볼륨: {calculateVolume(record.sets).toLocaleString()}kg
                                        </div>
                                    </div>
                                ))}
                                {getExerciseHistory(selectedExercise.id).length === 0 && (
                                    <p className="text-center text-gray-400 py-8">기록이 없습니다</p>
                                )}
                            </div>
                        </Modal>
                    )}

                    {/* 난이도 선택 모달 */}
                    {showDifficultyModal && selectedRecordForDifficulty && (() => {
                        const exercise = exercises.find(e => e.id === selectedRecordForDifficulty.exerciseId);
                        const history = getExerciseHistory(selectedRecordForDifficulty.exerciseId);
                        const previousRecord = history.find(r => r.date < selectedDate && r.difficulty);
                        const previousDifficulty = previousRecord?.difficulty;

                        const handleDifficultySelect = (difficulty) => {
                            // 같은 난이도를 클릭하면 선택 해제
                            const newDifficulty = selectedRecordForDifficulty.difficulty === difficulty ? null : difficulty;
                            updateRecord(selectedRecordForDifficulty.id, { ...selectedRecordForDifficulty, difficulty: newDifficulty });
                            setShowDifficultyModal(false);
                            setSelectedRecordForDifficulty(null);
                        };

                        return (
                            <Modal onClose={() => { setShowDifficultyModal(false); setSelectedRecordForDifficulty(null); }} title={<span className="text-gray-800">운동 난이도</span>}>
                                <div className="space-y-4">
                                    {/* 지난 난이도 */}
                                    {previousDifficulty && (() => {
                                        const prevInfo = getDifficultyInfo(previousDifficulty);
                                        return (
                                            <div className="flex items-center gap-2 mb-2">
                                                <span className="text-sm text-gray-500">지난 난이도:</span>
                                                <div
                                                    className="flex items-center gap-1 pl-1 pr-1.5 bg-white rounded-full border border-gray-200 text-gray-400"
                                                    style={{height: '28px'}}
                                                    dangerouslySetInnerHTML={{__html: prevInfo.icon + '<span class="text-sm font-normal">' + prevInfo.text + '</span>'}}
                                                />
                                            </div>
                                        );
                                    })()}

                                    {/* 난이도 선택 버튼 */}
                                    <div className="space-y-3">
                                        {['easy', 'medium', 'hard'].map(level => {
                                            const info = getDifficultyInfo(level);
                                            const isSelected = selectedRecordForDifficulty.difficulty === level;
                                            return (
                                                <button
                                                    key={level}
                                                    onClick={() => handleDifficultySelect(level)}
                                                    className={`w-full flex items-center gap-3 p-4 rounded-lg border-2 transition-all ${
                                                        isSelected
                                                            ? 'border-[#A295D5] bg-[#F3F1FA]'
                                                            : 'border-gray-200 bg-white hover:border-gray-300'
                                                    }`}
                                                >
                                                    <div
                                                        className={isSelected ? 'text-[#A295D5]' : 'text-gray-600'}
                                                        dangerouslySetInnerHTML={{__html: info.icon}}
                                                    />
                                                    <span className={`text-base font-medium ${isSelected ? 'text-[#A295D5]' : 'text-gray-600'}`}>
                                                        {info.text}
                                                    </span>
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>
                            </Modal>
                        );
                    })()}

                    {/* 성장률 상세 모달 */}
                    {showGrowthDetailModal && routineGrowth && (
                        <Modal onClose={() => setShowGrowthDetailModal(false)} title={<span className="text-gray-800">성장률 상세</span>}>
                            <div className="space-y-4">
                                {/* 운동별 비교 */}
                                <div className="space-y-4">
                                    {routineGrowth.comparisons.map((comparison, index) => {
                                        const exercise = exercises.find(e => e.id === comparison.exerciseId);
                                        if (!exercise) return null;

                                        return (
                                            <div key={index} className="border border-gray-200 rounded-lg p-4 bg-white">
                                                {/* 운동 이름과 성장률 */}
                                                <div className="flex items-center justify-between mb-3">
                                                    <h4 className="font-bold text-gray-800">{exercise.name} ({formatDateKorean(comparison.previousRecord.date)})</h4>
                                                    <span className={`text-base font-bold ${
                                                        comparison.growth > 0
                                                            ? 'text-[#2D9C61]'
                                                            : comparison.growth === 0
                                                                ? 'text-[#847DC4]'
                                                                : 'text-[#E75D7DCC]'
                                                    }`}>
                                                        {comparison.growth >= 0 ? '+' : ''}{comparison.growth.toFixed(1)}%
                                                    </span>
                                                </div>

                                                {/* 과거 기록 */}
                                                <div>
                                                    <div className="bg-gray-50 p-3 rounded-lg">
                                                        <div className="space-y-1 mb-2">
                                                            {comparison.previousRecord.sets.map((set, setIndex) => (
                                                                <div key={setIndex} className="text-sm text-gray-700">
                                                                    세트 {setIndex + 1}: {set.weight}kg × {set.reps}회
                                                                </div>
                                                            ))}
                                                        </div>
                                                        <div className="text-sm text-gray-500 font-medium">
                                                            총 볼륨: {comparison.previousVolume.toLocaleString()}kg
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </Modal>
                    )}

                    {/* 키보드를 위한 스크롤 여백 */}
                    {/* 커스텀 키보드 */}
                    {showKeyboard && (
                        <div className="fixed bottom-0 left-0 right-0 flex items-end justify-center z-50">
                            <div className="w-full bg-[#CCCCCC] p-1">
                                <div className="grid gap-1" style={{gridTemplateColumns: '1.2fr 1.2fr 1.2fr 0.8fr 0.8fr', gridAutoRows: 'minmax(53px, auto)'}}>
                                    {/* Row 1 */}
                                    <button onClick={() => handleKeyboardInput('1')} className="bg-white rounded flex items-center justify-center text-[#373737]" style={{fontSize: 'clamp(20px, 6.7vw, 25px)'}}>1</button>
                                    <button onClick={() => handleKeyboardInput('2')} className="bg-white rounded flex items-center justify-center text-[#373737]" style={{fontSize: 'clamp(20px, 6.7vw, 25px)'}}>2</button>
                                    <button onClick={() => handleKeyboardInput('3')} className="bg-white rounded flex items-center justify-center text-[#373737]" style={{fontSize: 'clamp(20px, 6.7vw, 25px)'}}>3</button>
                                    <button onClick={() => handleKeyboardInput('-1')} className="bg-[#EBE7FA] rounded flex items-center justify-center text-[#320D3E]" style={{fontSize: 'clamp(16px, 5.3vw, 20px)'}}>-1</button>
                                    <button onClick={() => handleKeyboardInput('+1')} className="bg-[#EBE7FA] rounded flex items-center justify-center text-[#320D3E]" style={{fontSize: 'clamp(16px, 5.3vw, 20px)'}}>+1</button>

                                    {/* Row 2 */}
                                    <button onClick={() => handleKeyboardInput('4')} className="bg-white rounded flex items-center justify-center text-[#373737]" style={{fontSize: 'clamp(20px, 6.7vw, 25px)'}}>4</button>
                                    <button onClick={() => handleKeyboardInput('5')} className="bg-white rounded flex items-center justify-center text-[#373737]" style={{fontSize: 'clamp(20px, 6.7vw, 25px)'}}>5</button>
                                    <button onClick={() => handleKeyboardInput('6')} className="bg-white rounded flex items-center justify-center text-[#373737]" style={{fontSize: 'clamp(20px, 6.7vw, 25px)'}}>6</button>
                                    <button onClick={() => handleKeyboardInput('-5')} className="bg-[#EBE7FA] rounded flex items-center justify-center text-[#320D3E]" style={{fontSize: 'clamp(16px, 5.3vw, 20px)'}}>-5</button>
                                    <button onClick={() => handleKeyboardInput('+5')} className="bg-[#EBE7FA] rounded flex items-center justify-center text-[#320D3E]" style={{fontSize: 'clamp(16px, 5.3vw, 20px)'}}>+5</button>

                                    {/* Row 3 */}
                                    <button onClick={() => handleKeyboardInput('7')} className="bg-white rounded flex items-center justify-center text-[#373737]" style={{fontSize: 'clamp(20px, 6.7vw, 25px)'}}>7</button>
                                    <button onClick={() => handleKeyboardInput('8')} className="bg-white rounded flex items-center justify-center text-[#373737]" style={{fontSize: 'clamp(20px, 6.7vw, 25px)'}}>8</button>
                                    <button onClick={() => handleKeyboardInput('9')} className="bg-white rounded flex items-center justify-center text-[#373737]" style={{fontSize: 'clamp(20px, 6.7vw, 25px)'}}>9</button>
                                    <button onClick={() => handleKeyboardInput('next')} className="bg-[#A295D5] rounded col-span-2 flex items-center justify-center text-white font-medium" style={{fontSize: 'clamp(16px, 5.3vw, 20px)'}}>NEXT</button>

                                    {/* Row 4 */}
                                    <button onClick={() => handleKeyboardInput('.')} className="bg-white rounded flex items-center justify-center text-[#373737]" style={{fontSize: 'clamp(20px, 6.7vw, 25px)'}}>.</button>
                                    <button onClick={() => handleKeyboardInput('0')} className="bg-white rounded flex items-center justify-center text-[#373737]" style={{fontSize: 'clamp(20px, 6.7vw, 25px)'}}>0</button>
                                    <button onClick={() => handleKeyboardInput('backspace')} className="bg-white rounded flex items-center justify-center">
                                        <svg style={{width: 'clamp(20px, 6.4vw, 24px)', height: 'clamp(20px, 6.4vw, 24px)'}} viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M20.2502 3.75H6.42492C6.16602 3.75075 5.91167 3.81816 5.68638 3.94574C5.4611 4.07333 5.27247 4.25679 5.13867 4.47844L0.857107 11.6137C0.787025 11.7304 0.75 11.8639 0.75 12C0.75 12.1361 0.787025 12.2696 0.857107 12.3862L5.13867 19.5216C5.27247 19.7432 5.4611 19.9267 5.68638 20.0543C5.91167 20.1818 6.16602 20.2493 6.42492 20.25H20.2502C20.6481 20.25 21.0296 20.092 21.3109 19.8107C21.5922 19.5294 21.7502 19.1478 21.7502 18.75V5.25C21.7502 4.85218 21.5922 4.47064 21.3109 4.18934C21.0296 3.90804 20.6481 3.75 20.2502 3.75ZM20.2502 18.75H6.42492L2.37492 12L6.42492 5.25H20.2502V18.75ZM9.96961 13.7194L11.6899 12L9.96961 10.2806C9.82888 10.1399 9.74982 9.94902 9.74982 9.75C9.74982 9.55098 9.82888 9.36011 9.96961 9.21937C10.1103 9.07864 10.3012 8.99958 10.5002 8.99958C10.6993 8.99958 10.8901 9.07864 11.0309 9.21937L12.7502 10.9397L14.4696 9.21937C14.5393 9.14969 14.622 9.09442 14.7131 9.0567C14.8041 9.01899 14.9017 8.99958 15.0002 8.99958C15.0988 8.99958 15.1964 9.01899 15.2874 9.0567C15.3785 9.09442 15.4612 9.14969 15.5309 9.21937C15.6005 9.28906 15.6558 9.37178 15.6935 9.46283C15.7312 9.55387 15.7507 9.65145 15.7507 9.75C15.7507 9.84855 15.7312 9.94613 15.6935 10.0372C15.6558 10.1282 15.6005 10.2109 15.5309 10.2806L13.8105 12L15.5309 13.7194C15.6005 13.7891 15.6558 13.8718 15.6935 13.9628C15.7312 14.0539 15.7507 14.1515 15.7507 14.25C15.7507 14.3485 15.7312 14.4461 15.6935 14.5372C15.6558 14.6282 15.6005 14.7109 15.5309 14.7806C15.4612 14.8503 15.3785 14.9056 15.2874 14.9433C15.1964 14.981 15.0988 15.0004 15.0002 15.0004C14.9017 15.0004 14.8041 14.981 14.7131 14.9433C14.622 14.9056 14.5393 14.8503 14.4696 14.7806L12.7502 13.0603L11.0309 14.7806C10.9612 14.8503 10.8785 14.9056 10.7874 14.9433C10.6964 14.981 10.5988 15.0004 10.5002 15.0004C10.4017 15.0004 10.3041 14.981 10.2131 14.9433C10.122 14.9056 10.0393 14.8503 9.96961 14.7806C9.89993 14.7109 9.84465 14.6282 9.80694 14.5372C9.76923 14.4461 9.74982 14.3485 9.74982 14.25C9.74982 14.1515 9.76923 14.0539 9.80694 13.9628C9.84465 13.8718 9.89993 13.7891 9.96961 13.7194Z" fill="black"/>
                                        </svg>
                                    </button>
                                    <button onClick={closeKeyboard} className="bg-[#F5F5F5] rounded col-span-2 flex items-center justify-center text-[#9CA3AF]" style={{fontSize: 'clamp(16px, 5.3vw, 20px)'}}>닫기</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // 캘린더 페이지
        function CalendarPage({ records, exercises, setCurrentPage, setSelectedDate }) {
            const [currentMonth, setCurrentMonth] = useState(new Date());
            const [selectedDay, setSelectedDay] = useState(null);

            const daysInMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate();
            const firstDayOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1).getDay();

            const prevMonth = () => {
                setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1));
                setSelectedDay(null);
            };

            const nextMonth = () => {
                setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1));
                setSelectedDay(null);
            };

            const getRecordsForDate = (day) => {
                const dateStr = formatDate(new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day));
                return records.filter(r => r.date === dateStr && r.sets && r.sets.length > 0);
            };

            const handleDateClick = (day) => {
                setSelectedDay(day);
            };

            const calculateVolume = (sets) => {
                return sets.reduce((total, set) => {
                    const weight = parseFloat(set.weight) || 0;
                    const reps = parseFloat(set.reps) || 0;
                    return total + (weight * reps);
                }, 0);
            };

            // 이번 달 운동 기록 횟수 계산
            const getMonthWorkoutCount = () => {
                const year = currentMonth.getFullYear();
                const month = currentMonth.getMonth();

                const datesWithWorkouts = new Set();
                records.forEach(record => {
                    if (record.sets && record.sets.length > 0) {
                        const recordDate = new Date(record.date);
                        if (recordDate.getFullYear() === year && recordDate.getMonth() === month) {
                            datesWithWorkouts.add(record.date);
                        }
                    }
                });

                return datesWithWorkouts.size;
            };

            const monthWorkoutCount = getMonthWorkoutCount();
            const selectedDayRecords = selectedDay ? getRecordsForDate(selectedDay) : [];

            return (
                <div className="p-4">
                    {/* 이번 달 운동 횟수 */}
                    <div className="mb-4 p-3 bg-[#F3F1FA] border border-[#D4CDEB] rounded-lg text-center">
                        <span className="text-sm text-gray-700">
                            이번달은 <span className="font-bold text-[#A295D5]">{monthWorkoutCount}번</span> 헬스장에 갔습니다
                        </span>
                    </div>

                    {/* 월 선택 */}
                    <div className="flex items-center justify-between mb-4">
                        <button onClick={prevMonth} className="p-2">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M14.4697 5.46967C14.7626 5.17678 15.2373 5.17678 15.5302 5.46967C15.8231 5.76256 15.8231 6.23732 15.5302 6.53022L10.0605 11.9999L15.5302 17.4697C15.8231 17.7626 15.8231 18.2373 15.5302 18.5302C15.2373 18.8231 14.7626 18.8231 14.4697 18.5302L8.46967 12.5302C8.17678 12.2373 8.17678 11.7626 8.46967 11.4697L14.4697 5.46967Z" fill="#3F4146"/>
                            </svg>
                        </button>
                        <span className="text-lg font-bold">
                            {currentMonth.getFullYear()}년 {currentMonth.getMonth() + 1}월
                        </span>
                        <button onClick={nextMonth} className="p-2">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8.46967 5.84467C8.76256 5.55178 9.23732 5.55178 9.53022 5.84467L15.5302 11.8447C15.8231 12.1376 15.8231 12.6123 15.5302 12.9052L9.53022 18.9052C9.23732 19.1981 8.76256 19.1981 8.46967 18.9052C8.17678 18.6123 8.17678 18.1376 8.46967 17.8447L13.9394 12.3749L8.46967 6.90522C8.17678 6.61232 8.17678 6.13756 8.46967 5.84467Z" fill="#3F4146"/>
                            </svg>
                        </button>
                    </div>

                    {/* 요일 헤더 */}
                    <div className="grid grid-cols-7 gap-1 mb-2">
                        {['일', '월', '화', '수', '목', '금', '토'].map(day => (
                            <div key={day} className="text-center text-sm font-bold text-gray-600 py-2">
                                {day}
                            </div>
                        ))}
                    </div>

                    {/* 날짜 그리드 */}
                    <div className="grid grid-cols-7 gap-1 mb-4">
                        {[...Array(firstDayOfMonth)].map((_, i) => (
                            <div key={`empty-${i}`} className="aspect-square"></div>
                        ))}
                        {[...Array(daysInMonth)].map((_, i) => {
                            const day = i + 1;
                            const dayRecords = getRecordsForDate(day);
                            const hasRecords = dayRecords.length > 0;
                            const isSelected = selectedDay === day;

                            return (
                                <button
                                    key={day}
                                    onClick={() => handleDateClick(day)}
                                    className={`aspect-square border rounded flex flex-col items-center justify-center ${
                                        isSelected
                                            ? 'bg-[#A295D5] text-white border-[#A295D5]'
                                            : hasRecords
                                                ? 'bg-[#F3F1FA] border-[#D4CDEB]'
                                                : 'border-gray-200'
                                    }`}
                                >
                                    <span className="text-sm">{day}</span>
                                    {hasRecords && !isSelected && (
                                        <span className="text-xs text-[#A295D5] mt-1">●</span>
                                    )}
                                </button>
                            );
                        })}
                    </div>

                    {/* 선택된 날짜의 운동 요약 */}
                    {selectedDay && (
                        <div className="bg-white border border-gray-200 rounded-lg p-4">
                            <h3 className="font-bold text-lg text-gray-800 mb-3">
                                {formatDateKorean(formatDate(new Date(currentMonth.getFullYear(), currentMonth.getMonth(), selectedDay)))}
                            </h3>
                            
                            {selectedDayRecords.length > 0 ? (
                                <div className="space-y-3">
                                    {selectedDayRecords.map(record => {
                                        const exercise = exercises.find(e => e.id === record.exerciseId);
                                        if (!exercise) return null;

                                        return (
                                            <div key={record.id} className="bg-gray-50 p-3 rounded-lg">
                                                <div className="flex items-center justify-between mb-2">
                                                    <h4 className="font-bold text-gray-800">{exercise.name}</h4>
                                                    <span className="text-xs text-gray-500 bg-[#EEEEEE] px-2 py-1 rounded">
                                                        {exercise.tag}
                                                    </span>
                                                </div>
                                                {record.sets && record.sets.length > 0 ? (
                                                    <>
                                                        <div className="space-y-1 mb-2">
                                                            {record.sets.map((set, index) => (
                                                                <div key={index} className="text-sm text-gray-700">
                                                                    세트 {index + 1}: {set.weight}kg × {set.reps}회
                                                                </div>
                                                            ))}
                                                        </div>
                                                        <div className="text-sm text-gray-500 font-medium">
                                                            총 볼륨: {calculateVolume(record.sets).toLocaleString()}kg
                                                        </div>
                                                    </>
                                                ) : (
                                                    <div className="text-sm text-gray-400">기록 없음</div>
                                                )}
                                            </div>
                                        );
                                    })}
                                    
                                    {/* 편집 버튼 */}
                                    <button
                                        onClick={() => {
                                            const dateStr = formatDate(new Date(currentMonth.getFullYear(), currentMonth.getMonth(), selectedDay));
                                            setSelectedDate(dateStr);
                                            setCurrentPage('home');
                                        }}
                                        className="w-full mt-3 bg-[#A295D5] text-white py-3 rounded-lg font-medium hover:bg-[#8E7FC4]"
                                    >
                                        이 날짜 편집하기
                                    </button>
                                </div>
                            ) : (
                                <div className="flex flex-col justify-between" style={{minHeight: '270px'}}>
                                    <div className="text-center pt-5">
                                        <img src="angry.png" alt="운동 기록 없음" className="mx-auto mb-4" style={{maxWidth: '160px'}} />
                                        <p className="text-gray-400">왜 운동 안하냐몽!?</p>
                                    </div>

                                    {/* 편집 버튼 */}
                                    <button
                                        onClick={() => {
                                            const dateStr = formatDate(new Date(currentMonth.getFullYear(), currentMonth.getMonth(), selectedDay));
                                            setSelectedDate(dateStr);
                                            setCurrentPage('home');
                                        }}
                                        className="w-full bg-[#A295D5] text-white py-3 rounded-lg font-medium hover:bg-[#8E7FC4]"
                                    >
                                        이 날짜 편집하기
                                    </button>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        // 루틴 페이지
        function RoutinesPage({ routines, exercises, addRoutine, setCurrentPage, setRoutines }) {
            const [showModal, setShowModal] = useState(false);
            const [routineName, setRoutineName] = useState('');
            const [selectedExercises, setSelectedExercises] = useState([]);
            const [selectedTagFilter, setSelectedTagFilter] = useState('전체');
            const [editingRoutine, setEditingRoutine] = useState(null);
            const [editingExerciseIds, setEditingExerciseIds] = useState([]);
            const [deleteConfirm, setDeleteConfirm] = useState(null);
            const [showDataModal, setShowDataModal] = useState(false);

            const tags = ['전체', ...new Set(exercises.map(e => e.tag))];
            
            const filteredExercises = selectedTagFilter === '전체'
                ? exercises
                : exercises.filter(e => e.tag === selectedTagFilter);

            const handleCreateRoutine = () => {
                if (routineName.trim() && selectedExercises.length > 0) {
                    // 중복 이름 체크
                    if (routines.some(r => r.name.trim() === routineName.trim())) {
                        alert('이미 같은 이름의 루틴이 있습니다!');
                        return;
                    }

                    addRoutine({
                        name: routineName,
                        exerciseIds: selectedExercises
                    });
                    setRoutineName('');
                    setSelectedExercises([]);
                    setSelectedTagFilter('전체');
                    setShowModal(false);
                }
            };

            const toggleExercise = (exerciseId) => {
                if (selectedExercises.includes(exerciseId)) {
                    setSelectedExercises(selectedExercises.filter(id => id !== exerciseId));
                } else {
                    setSelectedExercises([...selectedExercises, exerciseId]);
                }
            };

            const handleDeleteRoutine = (routineId, e) => {
                e.stopPropagation();
                setDeleteConfirm(routineId);
            };

            const confirmDeleteRoutine = () => {
                if (deleteConfirm) {
                    setRoutines(routines.filter(r => r.id !== deleteConfirm));
                    setDeleteConfirm(null);
                }
            };

            const handleRoutineClick = (routine) => {
                setEditingRoutine(routine);
                setEditingExerciseIds([...routine.exerciseIds]);
            };

            const saveRoutineOrder = () => {
                setRoutines(routines.map(r =>
                    r.id === editingRoutine.id
                        ? { ...r, exerciseIds: editingExerciseIds }
                        : r
                ));
                setEditingRoutine(null);
                setEditingExerciseIds([]);
            };

            // 데이터 내보내기 (JSON 다운로드)
            const handleExportData = () => {
                const data = {
                    exercises: localStorage.getItem('workout_exercises'),
                    records: localStorage.getItem('workout_records'),
                    routines: localStorage.getItem('workout_routines'),
                    exportDate: new Date().toISOString()
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `메타몽_백업_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                setShowDataModal(false);
            };

            // 데이터 불러오기 (JSON 업로드)
            const handleImportData = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);

                            if (confirm('현재 데이터가 모두 덮어씌워집니다. 계속하시겠습니까?')) {
                                localStorage.setItem('workout_exercises', data.exercises);
                                localStorage.setItem('workout_records', data.records);
                                localStorage.setItem('workout_routines', data.routines);
                                alert('데이터를 불러왔습니다. 페이지를 새로고침합니다.');
                                window.location.reload();
                            }
                        } catch (error) {
                            alert('파일을 읽을 수 없습니다. 올바른 백업 파일인지 확인해주세요.');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
                setShowDataModal(false);
            };

            return (
                <div className="p-4">
                    <button
                        onClick={() => setShowModal(true)}
                        className="w-full bg-[#A295D5] text-white py-3 rounded-lg font-medium mb-4 hover:bg-[#8E7FC4]"
                    >
                        + 새 루틴 만들기
                    </button>

                    <div className="space-y-3">
                        {routines.map(routine => (
                            <div
                                key={routine.id}
                                onClick={() => handleRoutineClick(routine)}
                                className="bg-white border border-gray-200 rounded-lg p-4 cursor-pointer hover:bg-gray-50"
                            >
                                <div className="flex items-center justify-between mb-2">
                                    <h3 className="font-bold text-lg text-gray-800">{routine.name}</h3>
                                    <button
                                        onClick={(e) => handleDeleteRoutine(routine.id, e)}
                                    >
                                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M13.75 10C13.75 10.1658 13.6842 10.3247 13.5669 10.4419C13.4497 10.5592 13.2908 10.625 13.125 10.625H6.875C6.70924 10.625 6.55027 10.5592 6.43306 10.4419C6.31585 10.3247 6.25 10.1658 6.25 10C6.25 9.83424 6.31585 9.67527 6.43306 9.55806C6.55027 9.44085 6.70924 9.375 6.875 9.375H13.125C13.2908 9.375 13.4497 9.44085 13.5669 9.55806C13.6842 9.67527 13.75 9.83424 13.75 10ZM18.125 10C18.125 11.607 17.6485 13.1779 16.7557 14.514C15.8629 15.8502 14.594 16.8916 13.1093 17.5065C11.6247 18.1215 9.99099 18.2824 8.41489 17.9689C6.8388 17.6554 5.39106 16.8815 4.25476 15.7452C3.11846 14.6089 2.34463 13.1612 2.03112 11.5851C1.71762 10.009 1.87852 8.37535 2.49348 6.8907C3.10844 5.40605 4.14985 4.1371 5.486 3.24431C6.82214 2.35152 8.39303 1.875 10 1.875C12.1542 1.87727 14.2195 2.73403 15.7427 4.25727C17.266 5.78051 18.1227 7.84581 18.125 10ZM16.875 10C16.875 8.64025 16.4718 7.31104 15.7164 6.18045C14.9609 5.04987 13.8872 4.16868 12.631 3.64833C11.3747 3.12798 9.99238 2.99183 8.65876 3.2571C7.32514 3.52237 6.10013 4.17715 5.13864 5.13864C4.17716 6.10013 3.52238 7.32513 3.2571 8.65875C2.99183 9.99237 3.12798 11.3747 3.64833 12.6309C4.16868 13.8872 5.04987 14.9609 6.18046 15.7164C7.31105 16.4718 8.64026 16.875 10 16.875C11.8227 16.8729 13.5702 16.1479 14.8591 14.8591C16.1479 13.5702 16.8729 11.8227 16.875 10Z" fill="#C1BBC3"/>
                                        </svg>
                                    </button>
                                </div>
                                <div className="flex flex-wrap gap-2">
                                    {routine.exerciseIds.map(id => {
                                        const exercise = exercises.find(e => e.id === id);
                                        return exercise ? (
                                            <span key={id} className="text-sm bg-gray-100 px-3 py-1 rounded-full text-gray-700">
                                                {exercise.name}
                                            </span>
                                        ) : null;
                                    })}
                                </div>
                            </div>
                        ))}

                        {routines.length === 0 && (
                            <div className="text-center py-12">
                                <img src="routine.png" alt="루틴 없음" className="mx-auto mb-4" style={{maxWidth: '200px'}} />
                                <p className="text-gray-400">저장된 루틴이 없습니다</p>
                            </div>
                        )}
                    </div>

                    {/* 데이터 관리 모달 */}
                    {showDataModal && (
                        <Modal onClose={() => setShowDataModal(false)} title="데이터 관리">
                            <div className="space-y-3">
                                <button
                                    onClick={handleExportData}
                                    className="w-full bg-[#A295D5] text-white py-3 rounded-lg font-medium hover:bg-[#8E7FC4]"
                                >
                                    데이터 내보내기
                                </button>
                                <button
                                    onClick={handleImportData}
                                    className="w-full bg-white text-gray-700 py-3 rounded-lg font-medium border border-gray-300 hover:bg-gray-50"
                                >
                                    데이터 불러오기
                                </button>
                            </div>
                        </Modal>
                    )}

                    {showModal && (
                        <Modal onClose={() => setShowModal(false)} title="새 루틴 만들기">
                            <div className="space-y-4">
                                <input
                                    type="text"
                                    value={routineName}
                                    onChange={(e) => setRoutineName(e.target.value)}
                                    placeholder="루틴 이름 (예: 하체 루틴)"
                                    className="w-full p-3 border border-gray-300 rounded-lg"
                                />

                                <div>
                                    <div className="flex items-center justify-between mb-2">
                                        <h4 className="font-bold text-gray-700">운동 선택</h4>
                                        {selectedExercises.length > 0 && (
                                            <span className="text-sm text-[#A295D5]">
                                                {selectedExercises.length}개 선택됨
                                            </span>
                                        )}
                                    </div>

                                    {/* 태그 필터 */}
                                    <div className="flex gap-2 mb-3 overflow-x-auto pb-2 hide-scrollbar">
                                        {tags.map(tag => (
                                            <button
                                                key={tag}
                                                type="button"
                                                onClick={() => setSelectedTagFilter(tag)}
                                                className={`px-3 py-1 rounded-full whitespace-nowrap text-sm ${
                                                    selectedTagFilter === tag
                                                        ? 'bg-[#A295D5] text-white'
                                                        : 'bg-gray-100 text-gray-700'
                                                }`}
                                            >
                                                {tag}
                                            </button>
                                        ))}
                                    </div>

                                    <div className="space-y-2 max-h-96 overflow-y-auto">
                                        {filteredExercises.map(exercise => (
                                            <label key={exercise.id} className="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                                <input
                                                    type="checkbox"
                                                    checked={selectedExercises.includes(exercise.id)}
                                                    onChange={() => toggleExercise(exercise.id)}
                                                    className="mr-3"
                                                />
                                                <div>
                                                    <div className="font-medium text-gray-800">{exercise.name}</div>
                                                    <div className="text-xs text-gray-500">{exercise.tag}</div>
                                                </div>
                                            </label>
                                        ))}
                                        {filteredExercises.length === 0 && (
                                            <p className="text-center text-gray-400 py-4">이 태그의 운동이 없습니다</p>
                                        )}
                                    </div>
                                </div>

                                <button
                                    onClick={handleCreateRoutine}
                                    disabled={!routineName.trim() || selectedExercises.length === 0}
                                    className="w-full bg-[#A295D5] text-white py-3 rounded-lg font-medium hover:bg-[#8E7FC4] disabled:bg-gray-300 disabled:cursor-not-allowed"
                                >
                                    루틴 저장
                                </button>
                            </div>
                        </Modal>
                    )}

                    {/* 루틴 편집 모달 (운동 추가/삭제) */}
                    {editingRoutine && (
                        <Modal onClose={() => { setEditingRoutine(null); setEditingExerciseIds([]); setSelectedTagFilter('전체'); }} title={`${editingRoutine.name} 편집`}>
                            <div className="space-y-4">
                                {/* 현재 루틴의 운동 목록 */}
                                <div>
                                    <h4 className="font-bold text-gray-700 mb-2">현재 운동 목록</h4>
                                    <div className="space-y-2">
                                        {editingExerciseIds.map((id) => {
                                            const exercise = exercises.find(e => e.id === id);
                                            if (!exercise) return null;

                                            return (
                                                <div
                                                    key={id}
                                                    className="bg-gray-50 p-3 rounded-lg flex items-center justify-between"
                                                >
                                                    <div className="flex-1">
                                                        <div className="font-medium text-gray-800">{exercise.name}</div>
                                                        <div className="text-xs text-gray-500">{exercise.tag}</div>
                                                    </div>
                                                    <button
                                                        onClick={() => setEditingExerciseIds(editingExerciseIds.filter(eid => eid !== id))}
                                                        className="text-red-500 hover:text-red-700"
                                                    >
                                                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                            <path d="M13.75 10C13.75 10.1658 13.6842 10.3247 13.5669 10.4419C13.4497 10.5592 13.2908 10.625 13.125 10.625H6.875C6.70924 10.625 6.55027 10.5592 6.43306 10.4419C6.31585 10.3247 6.25 10.1658 6.25 10C6.25 9.83424 6.31585 9.67527 6.43306 9.55806C6.55027 9.44085 6.70924 9.375 6.875 9.375H13.125C13.2908 9.375 13.4497 9.44085 13.5669 9.55806C13.6842 9.67527 13.75 9.83424 13.75 10ZM18.125 10C18.125 11.607 17.6485 13.1779 16.7557 14.514C15.8629 15.8502 14.594 16.8916 13.1093 17.5065C11.6247 18.1215 9.99099 18.2824 8.41489 17.9689C6.8388 17.6554 5.39106 16.8815 4.25476 15.7452C3.11846 14.6089 2.34463 13.1612 2.03112 11.5851C1.71762 10.009 1.87852 8.37535 2.49348 6.8907C3.10844 5.40605 4.14985 4.1371 5.486 3.24431C6.82214 2.35152 8.39303 1.875 10 1.875C12.1542 1.87727 14.2195 2.73403 15.7427 4.25727C17.266 5.78051 18.1227 7.84581 18.125 10ZM16.875 10C16.875 8.64025 16.4718 7.31104 15.7164 6.18045C14.9609 5.04987 13.8872 4.16868 12.631 3.64833C11.3747 3.12798 9.99238 2.99183 8.65876 3.2571C7.32514 3.52237 6.10013 4.17715 5.13864 5.13864C4.17716 6.10013 3.52238 7.32513 3.2571 8.65875C2.99183 9.99237 3.12798 11.3747 3.64833 12.6309C4.16868 13.8872 5.04987 14.9609 6.18046 15.7164C7.31105 16.4718 8.64026 16.875 10 16.875C11.8227 16.8729 13.5702 16.1479 14.8591 14.8591C16.1479 13.5702 16.8729 11.8227 16.875 10Z" fill="currentColor"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                            );
                                        })}
                                        {editingExerciseIds.length === 0 && (
                                            <p className="text-center text-gray-400 py-4">운동이 없습니다</p>
                                        )}
                                    </div>
                                </div>

                                {/* 운동 추가 섹션 */}
                                <div>
                                    <h4 className="font-bold text-gray-700 mb-2">운동 추가</h4>

                                    {/* 태그 필터 */}
                                    <div className="flex gap-2 mb-3 overflow-x-auto pb-2 hide-scrollbar">
                                        {tags.map(tag => (
                                            <button
                                                key={tag}
                                                type="button"
                                                onClick={() => setSelectedTagFilter(tag)}
                                                className={`px-3 py-1 rounded-full whitespace-nowrap text-sm ${
                                                    selectedTagFilter === tag
                                                        ? 'bg-[#A295D5] text-white'
                                                        : 'bg-gray-100 text-gray-700'
                                                }`}
                                            >
                                                {tag}
                                            </button>
                                        ))}
                                    </div>

                                    <div className="space-y-2 max-h-64 overflow-y-auto">
                                        {filteredExercises
                                            .filter(ex => !editingExerciseIds.includes(ex.id))
                                            .map(exercise => (
                                                <div
                                                    key={exercise.id}
                                                    onClick={() => setEditingExerciseIds([...editingExerciseIds, exercise.id])}
                                                    className="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"
                                                >
                                                    <div className="font-medium text-gray-800">{exercise.name}</div>
                                                    <div className="text-xs text-gray-500">{exercise.tag}</div>
                                                </div>
                                            ))}
                                        {filteredExercises.filter(ex => !editingExerciseIds.includes(ex.id)).length === 0 && (
                                            <p className="text-center text-gray-400 py-4">추가할 운동이 없습니다</p>
                                        )}
                                    </div>
                                </div>

                                <button
                                    onClick={saveRoutineOrder}
                                    className="w-full bg-[#A295D5] text-white py-3 rounded-lg font-medium hover:bg-[#8E7FC4]"
                                >
                                    저장
                                </button>
                            </div>
                        </Modal>
                    )}

                    {deleteConfirm && (
                        <ConfirmModal
                            message="이 루틴을 삭제하시겠습니까?"
                            onConfirm={confirmDeleteRoutine}
                            onCancel={() => setDeleteConfirm(null)}
                        />
                    )}

                    {/* 데이터 관리 버튼 - 하단 네비게이션 바로 위 */}
                    <div className="fixed bottom-20 left-0 right-0 max-w-md mx-auto text-center py-4 bg-white z-30">
                        <button
                            onClick={() => setShowDataModal(true)}
                            className="text-gray-400 text-sm underline hover:text-gray-600"
                        >
                            데이터 관리
                        </button>
                    </div>
                </div>
            );
        }

        // 운동 관리 페이지
        function ExercisesPage({ exercises, addExercise, records, setExercises }) {
            const [showModal, setShowModal] = useState(false);
            const [exerciseName, setExerciseName] = useState('');
            const [exerciseTag, setExerciseTag] = useState('');
            const [selectedTag, setSelectedTag] = useState('전체');
            const [selectedExercise, setSelectedExercise] = useState(null);
            const [deleteConfirm, setDeleteConfirm] = useState(null);
            const [editingExercise, setEditingExercise] = useState(null);
            const [editExerciseName, setEditExerciseName] = useState('');
            const [editExerciseTag, setEditExerciseTag] = useState('');
            const [showEditModal, setShowEditModal] = useState(false);

            const tags = ['전체', ...new Set(exercises.map(e => e.tag))];

            const filteredExercises = selectedTag === '전체'
                ? exercises
                : exercises.filter(e => e.tag === selectedTag);

            const handleAddExercise = () => {
                if (exerciseName.trim() && exerciseTag.trim()) {
                    // 중복 이름 체크
                    if (exercises.some(e => e.name.trim() === exerciseName.trim())) {
                        alert('이미 같은 이름의 운동이 있습니다!');
                        return;
                    }

                    addExercise({
                        name: exerciseName,
                        tag: exerciseTag
                    });
                    setExerciseName('');
                    setExerciseTag('');
                    setShowModal(false);
                }
            };

            const getExerciseHistory = (exerciseId) => {
                return records
                    .filter(r => r.exerciseId === exerciseId && r.sets && r.sets.length > 0)
                    .sort((a, b) => b.date.localeCompare(a.date));
            };

            const calculateVolume = (sets) => {
                return sets.reduce((total, set) => {
                    const weight = parseFloat(set.weight) || 0;
                    const reps = parseFloat(set.reps) || 0;
                    return total + (weight * reps);
                }, 0);
            };

            const handleDeleteExercise = (exerciseId, e) => {
                e.stopPropagation();
                setDeleteConfirm(exerciseId);
            };

            const confirmDeleteExercise = () => {
                if (deleteConfirm) {
                    setExercises(exercises.filter(ex => ex.id !== deleteConfirm));
                    setDeleteConfirm(null);
                }
            };

            const handleEditExercise = (exercise) => {
                setEditingExercise(exercise);
                setEditExerciseName(exercise.name);
                setEditExerciseTag(exercise.tag);
                setShowEditModal(true);
                setSelectedExercise(null);
            };

            const handleUpdateExercise = () => {
                if (!editingExercise) return;
                const newName = editExerciseName.trim();
                const newTag = editExerciseTag.trim();
                if (!newName || !newTag) return;
                setExercises(exercises.map(ex => ex.id === editingExercise.id ? { ...ex, name: newName, tag: newTag } : ex));
                setShowEditModal(false);
                setEditingExercise(null);
                setEditExerciseName('');
                setEditExerciseTag('');
            };

            return (
                <div className="p-4">
                    <button
                        onClick={() => setShowModal(true)}
                        className="w-full bg-[#A295D5] text-white py-3 rounded-lg font-medium mb-4 hover:bg-[#8E7FC4]"
                    >
                        + 새 운동 추가
                    </button>

                    {/* 태그 필터 */}
                    <div className="flex gap-2 mb-4 overflow-x-auto pb-2 hide-scrollbar">
                        {tags.map(tag => (
                            <button
                                key={tag}
                                onClick={() => setSelectedTag(tag)}
                                className={`px-4 py-2 rounded-full whitespace-nowrap ${
                                    selectedTag === tag
                                        ? 'bg-[#A295D5] text-white'
                                        : 'bg-gray-100 text-gray-700'
                                }`}
                            >
                                {tag}
                            </button>
                        ))}
                    </div>

                    {/* 운동 리스트 */}
                    <div className="space-y-2">
                        {filteredExercises.map(exercise => {
                            const exerciseCount = records.filter(r => r.exerciseId === exercise.id && r.sets && r.sets.length > 0).length;
                            return (
                                <div
                                    key={exercise.id}
                                    className="w-full bg-white border border-gray-200 rounded-lg p-4 hover:bg-gray-50 flex items-center justify-between"
                                >
                                    <button
                                        onClick={() => setSelectedExercise(exercise)}
                                        className="flex-1 text-left"
                                    >
                                        <div className="flex items-center gap-2">
                                            <span className="font-bold text-gray-800">{exercise.name}</span>
                                            {exerciseCount > 0 && (
                                                <span className="inline-flex items-center justify-center min-w-[24px] h-[24px] px-2 bg-gray-200 text-gray-600 text-xs font-medium rounded-full">
                                                    {exerciseCount}
                                                </span>
                                            )}
                                        </div>
                                        <div className="text-sm text-gray-500 mt-1">{exercise.tag}</div>
                                    </button>
                                    <button
                                        onClick={(e) => handleDeleteExercise(exercise.id, e)}
                                        className="ml-2 px-3"
                                    >
                                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M13.75 10C13.75 10.1658 13.6842 10.3247 13.5669 10.4419C13.4497 10.5592 13.2908 10.625 13.125 10.625H6.875C6.70924 10.625 6.55027 10.5592 6.43306 10.4419C6.31585 10.3247 6.25 10.1658 6.25 10C6.25 9.83424 6.31585 9.67527 6.43306 9.55806C6.55027 9.44085 6.70924 9.375 6.875 9.375H13.125C13.2908 9.375 13.4497 9.44085 13.5669 9.55806C13.6842 9.67527 13.75 9.83424 13.75 10ZM18.125 10C18.125 11.607 17.6485 13.1779 16.7557 14.514C15.8629 15.8502 14.594 16.8916 13.1093 17.5065C11.6247 18.1215 9.99099 18.2824 8.41489 17.9689C6.8388 17.6554 5.39106 16.8815 4.25476 15.7452C3.11846 14.6089 2.34463 13.1612 2.03112 11.5851C1.71762 10.009 1.87852 8.37535 2.49348 6.8907C3.10844 5.40605 4.14985 4.1371 5.486 3.24431C6.82214 2.35152 8.39303 1.875 10 1.875C12.1542 1.87727 14.2195 2.73403 15.7427 4.25727C17.266 5.78051 18.1227 7.84581 18.125 10ZM16.875 10C16.875 8.64025 16.4718 7.31104 15.7164 6.18045C14.9609 5.04987 13.8872 4.16868 12.631 3.64833C11.3747 3.12798 9.99238 2.99183 8.65876 3.2571C7.32514 3.52237 6.10013 4.17715 5.13864 5.13864C4.17716 6.10013 3.52238 7.32513 3.2571 8.65875C2.99183 9.99237 3.12798 11.3747 3.64833 12.6309C4.16868 13.8872 5.04987 14.9609 6.18046 15.7164C7.31105 16.4718 8.64026 16.875 10 16.875C11.8227 16.8729 13.5702 16.1479 14.8591 14.8591C16.1479 13.5702 16.8729 11.8227 16.875 10Z" fill="#C1BBC3"/>
                                        </svg>
                                    </button>
                                </div>
                            );
                        })}

                        {filteredExercises.length === 0 && (
                            <div className="text-center py-12">
                                <img src="workout.png" alt="운동 없음" className="mx-auto mb-4" style={{maxWidth: '200px'}} />
                                <p className="text-gray-400">운동이 없습니다</p>
                            </div>
                        )}
                    </div>

                    {/* 운동 추가 모달 */}
                    {showModal && (
                        <Modal onClose={() => setShowModal(false)} title="새 운동 추가">
                            <div className="space-y-4">
                                <input
                                    type="text"
                                    value={exerciseName}
                                    onChange={(e) => setExerciseName(e.target.value)}
                                    placeholder="운동 이름 (예: 벤치프레스)"
                                    className="w-full p-3 border border-gray-300 rounded-lg"
                                />
                                <div>
                                    <input
                                        type="text"
                                        list="tag-options"
                                        value={exerciseTag}
                                        onChange={(e) => setExerciseTag(e.target.value)}
                                        placeholder="태그 (예: 가슴, 하체, 등)"
                                        className="w-full p-3 border border-gray-300 rounded-lg"
                                    />
                                    <datalist id="tag-options">
                                        {tags.filter(tag => tag !== '전체').map(tag => (
                                            <option key={tag} value={tag} />
                                        ))}
                                    </datalist>
                                    {tags.length > 1 && (
                                        <div className="mt-2 flex flex-wrap gap-2">
                                            {tags.filter(tag => tag !== '전체').map(tag => (
                                                <button
                                                    key={tag}
                                                    type="button"
                                                    onClick={() => setExerciseTag(tag)}
                                                    className="bg-gray-100 hover:bg-[#F3F1FA] px-4 py-2 rounded-full text-gray-700"
                                                >
                                                    {tag}
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                <button
                                    onClick={handleAddExercise}
                                    disabled={!exerciseName.trim() || !exerciseTag.trim()}
                                    className="w-full bg-[#A295D5] text-white py-3 rounded-lg font-medium hover:bg-[#8E7FC4] disabled:bg-gray-300 disabled:cursor-not-allowed"
                                >
                                    운동 추가
                                </button>
                            </div>
                        </Modal>
                    )}

                    {/* 운동 히스토리 모달 */}
                    {selectedExercise && (
                        <Modal onClose={() => setSelectedExercise(null)} title={<span className="inline-flex items-center"><span className="text-gray-800">{`${selectedExercise.name} 히스토리`}</span><button onClick={() => handleEditExercise(selectedExercise)} className="p-1 hover:bg-gray-100 rounded" style={{marginLeft: '4px'}}><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><g clipPath="url(#clip0_435_10460)"><path d="M10.0001 3.33326L12.6668 5.99993M14.1161 4.54126C14.4686 4.18888 14.6666 3.71091 14.6667 3.2125C14.6668 2.71409 14.4688 2.23607 14.1165 1.8836C13.7641 1.53112 13.2861 1.33307 12.7877 1.33301C12.2893 1.33295 11.8113 1.53088 11.4588 1.88326L2.56145 10.7826C2.40667 10.9369 2.29219 11.127 2.22812 11.3359L1.34745 14.2373C1.33022 14.2949 1.32892 14.3562 1.34369 14.4145C1.35845 14.4728 1.38873 14.5261 1.43132 14.5686C1.4739 14.6111 1.5272 14.6413 1.58556 14.656C1.64392 14.6707 1.70516 14.6693 1.76279 14.6519L4.66479 13.7719C4.87357 13.7084 5.06357 13.5947 5.21812 13.4406L14.1161 4.54126Z" stroke="#374151" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/></g><defs><clipPath id="clip0_435_10460"><rect width="16" height="16" fill="white"/></clipPath></defs></svg></button></span>}>
                            <div className="space-y-4 max-h-[600px] overflow-y-auto">
                                {getExerciseHistory(selectedExercise.id).map(record => (
                                    <div key={record.id} className="bg-gray-50 p-4 rounded-lg">
                                        <div className="font-bold text-gray-800 mb-2">
                                            {formatDateKorean(record.date)}
                                        </div>
                                        <div className="space-y-1">
                                            {record.sets.map((set, index) => (
                                                <div key={index} className="text-sm text-gray-700">
                                                    세트 {index + 1}: {set.weight}kg × {set.reps}회
                                                </div>
                                            ))}
                                        </div>
                                        <div className="text-sm text-gray-500 mt-2">
                                            총 볼륨: {calculateVolume(record.sets).toLocaleString()}kg
                                        </div>
                                    </div>
                                ))}
                                {getExerciseHistory(selectedExercise.id).length === 0 && (
                                    <p className="text-center text-gray-400 py-8">기록이 없습니다</p>
                                )}
                            </div>
                        </Modal>
                    )}

                    {deleteConfirm && (
                        <ConfirmModal
                            message="운동 데이터를 삭제하시겠습니까?&#10;&#10;삭제 후에는 복구할 수 없습니다."
                            onConfirm={confirmDeleteExercise}
                            onCancel={() => setDeleteConfirm(null)}
                        />
                    )}

                    {showEditModal && (
                        <Modal onClose={() => setShowEditModal(false)} title="운동 수정">
                            <div className="space-y-4">
                                <input
                                    type="text"
                                    value={editExerciseName}
                                    onChange={(e) => setEditExerciseName(e.target.value)}
                                    placeholder="운동 이름 (예: 벤치프레스)"
                                    className="w-full p-3 border border-gray-300 rounded-lg"
                                />
                                <div>
                                    <input
                                        type="text"
                                        list="edit-tag-options"
                                        value={editExerciseTag}
                                        onChange={(e) => setEditExerciseTag(e.target.value)}
                                        placeholder="태그 (예: 가슴, 하체, 등)"
                                        className="w-full p-3 border border-gray-300 rounded-lg"
                                    />
                                    <datalist id="edit-tag-options">
                                        {tags.filter(tag => tag !== '전체').map(tag => (
                                            <option key={tag} value={tag} />
                                        ))}
                                    </datalist>
                                    {tags.length > 1 && (
                                        <div className="mt-2 flex flex-wrap gap-2">
                                            {tags.filter(tag => tag !== '전체').map(tag => (
                                                <button
                                                    key={tag}
                                                    type="button"
                                                    onClick={() => setEditExerciseTag(tag)}
                                                    className="bg-gray-100 hover:bg-[#F3F1FA] px-4 py-2 rounded-full text-gray-700"
                                                >
                                                    {tag}
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                <button
                                    onClick={handleUpdateExercise}
                                    disabled={!editExerciseName.trim() || !editExerciseTag.trim()}
                                    className="w-full bg-[#A295D5] text-white py-3 rounded-lg font-medium hover:bg-[#8E7FC4] disabled:bg-gray-300 disabled:cursor-not-allowed"
                                >
                                    운동 수정
                                </button>
                            </div>
                        </Modal>
                    )}
                </div>
            );
        }

        // 운동 선택 모달
        function ExerciseSelectModal({ exercises, onSelect, onClose }) {
            const [selectedTag, setSelectedTag] = useState('전체');

            const tags = ['전체', ...new Set(exercises.map(e => e.tag))];

            const filteredExercises = exercises.filter(e => {
                const matchesTag = selectedTag === '전체' || e.tag === selectedTag;
                return matchesTag;
            });

            return (
                <Modal onClose={onClose} title="운동 선택">
                    <div className="space-y-4">
                        <div className="flex gap-2 overflow-x-auto pb-2 hide-scrollbar">
                            {tags.map(tag => (
                                <button
                                    key={tag}
                                    onClick={() => setSelectedTag(tag)}
                                    className={`px-4 py-2 rounded-full whitespace-nowrap ${
                                        selectedTag === tag
                                            ? 'bg-[#A295D5] text-white'
                                            : 'bg-gray-100 text-gray-700'
                                    }`}
                                >
                                    {tag}
                                </button>
                            ))}
                        </div>

                        <div className="space-y-2 max-h-96 overflow-y-auto">
                            {filteredExercises.map(exercise => (
                                <button
                                    key={exercise.id}
                                    onClick={() => onSelect(exercise.id)}
                                    className="w-full bg-white border border-gray-200 rounded-lg p-4 hover:bg-[#F3F1FA] text-left"
                                >
                                    <div className="font-bold text-gray-800">{exercise.name}</div>
                                    <div className="text-sm text-gray-500 mt-1">{exercise.tag}</div>
                                </button>
                            ))}

                            {filteredExercises.length === 0 && (
                                <p className="text-center text-gray-400 py-8">해당 태그에 운동이 없습니다</p>
                            )}
                        </div>
                    </div>
                </Modal>
            );
        }

        // 모달 컴포넌트
        function Modal({ onClose, title, children }) {
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg max-w-md w-full max-h-[90vh] overflow-hidden">
                        <div className="flex items-center justify-between p-4">
                            <h2 className="text-xl font-bold text-gray-800">{title}</h2>
                            <button
                                onClick={onClose}
                                className="text-gray-500 hover:text-gray-700"
                            >
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M17.4697 4.99518C17.7626 4.70229 18.2373 4.70229 18.5302 4.99518C18.8231 5.28808 18.8231 5.76284 18.5302 6.05573L13.0605 11.5255L18.5302 16.9952C18.8231 17.2881 18.8231 17.7628 18.5302 18.0557C18.2373 18.3486 17.7626 18.3486 17.4697 18.0557L11.9999 12.586L6.53022 18.0557C6.23732 18.3486 5.76256 18.3486 5.46967 18.0557C5.17678 17.7628 5.17678 17.2881 5.46967 16.9952L10.9394 11.5255L5.46967 6.05573C5.17678 5.76284 5.17678 5.28808 5.46967 4.99518C5.76256 4.70229 6.23732 4.70229 6.53022 4.99518L11.9999 10.4649L17.4697 4.99518Z" fill="currentColor"/>
                                </svg>
                            </button>
                        </div>
                        <div className="border-b mx-4"></div>
                        <div className="p-4 overflow-y-auto" style={{ maxHeight: 'calc(90vh - 64px)' }}>
                            {children}
                        </div>
                    </div>
                </div>
            );
        }

        // 확인 모달 컴포넌트
        function ConfirmModal({ onConfirm, onCancel, message }) {
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg max-w-sm w-full">
                        <div className="p-6">
                            <p className="text-center text-gray-800 text-base mb-6">{message}</p>
                            <div className="flex gap-3">
                                <button
                                    onClick={onCancel}
                                    className="flex-1 py-3 bg-white border border-gray-300 rounded text-gray-700 text-sm"
                                >
                                    취소
                                </button>
                                <button
                                    onClick={onConfirm}
                                    className="flex-1 py-3 bg-[#A295D5] rounded text-white text-sm"
                                >
                                    삭제
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // 앱 렌더링
        ReactDOM.render(<App />, document.getElementById('root'));
        
        // 스플래시 화면 숨기기 (1.5초 후)
        setTimeout(() => {
            const splash = document.getElementById('splash-screen');
            if (splash) {
                splash.classList.add('hidden');
                setTimeout(() => splash.remove(), 500); // 페이드아웃 후 제거
            }
        }, 1500);

        // Service Worker 등록 (PWA 설치를 위해 필수)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(err => console.log('SW registration failed'));
            });
        }
    </script>
</body>
</html>